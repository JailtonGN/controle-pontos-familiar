<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Pontos - Controle de Pontos Familiar</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/png" href="assets/logo.png">
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-content">
                <!-- Brand -->
                <div class="navbar-brand">
                    <div class="navbar-logo"></div>
                    <div>
                        <div class="navbar-title">Gerenciar Pontos</div>
                        <div class="navbar-subtitle">Sistema de Pontos</div>
                    </div>
                </div>

                <!-- Desktop Menu -->
                <div class="navbar-menu">
                    <div class="navbar-item">
                        <a href="/dashboard" class="navbar-button" id="nav-dashboard">
                            <span class="navbar-button-text">Tela Inicial</span>
                        </a>
                    </div>
                    <div class="navbar-item">
                        <a href="/manage-points" class="navbar-button active" id="nav-activities">
                            <span class="navbar-button-text">Atividades</span>
                        </a>
                    </div>
                    <div class="navbar-item">
                        <a href="/kids" class="navbar-button" id="nav-kids">
                            <span class="navbar-button-text">Cadastros</span>
                        </a>
                    </div>
                    <div class="navbar-item">
                        <a href="/communication" class="navbar-button" id="nav-communication">
                            <span class="navbar-button-text">Comunica√ß√£o</span>
                        </a>
                    </div>
                    <div class="navbar-item">
                        <a href="/config" class="navbar-button" id="nav-settings">
                            <span class="navbar-button-text">Configura√ß√£o</span>
                        </a>
                    </div>
                </div>

                <!-- User Menu -->
                <div class="navbar-user">
                    <span id="user-name" class="navbar-user-name"></span>
                    <button onclick="logout()" class="navbar-button navbar-button-logout">
                        Sair
                    </button>
                </div>

                <!-- Mobile Menu Button -->
                <div class="navbar-mobile-menu">
                    <button class="navbar-mobile-button" onclick="toggleMobileMenu()">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile Menu -->
            <div id="mobile-menu" class="navbar-mobile-menu-content hidden">
                <a href="/dashboard" class="navbar-mobile-item" onclick="setActiveNav('nav-dashboard')">
                    Tela Inicial
                </a>
                <a href="/manage-points" class="navbar-mobile-item active" onclick="setActiveNav('nav-activities')">
                    Atividades
                </a>
                <a href="/kids" class="navbar-mobile-item" onclick="setActiveNav('nav-kids')">
                    Cadastros
                </a>
                <a href="/communication" class="navbar-mobile-item" onclick="setActiveNav('nav-communication')">
                    Comunica√ß√£o
                </a>
                <a href="/config" class="navbar-mobile-item" onclick="setActiveNav('nav-settings')">
                    Configura√ß√£o
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container" style="padding-top: 32px; padding-bottom: 32px;">
        <!-- T√≠tulo da P√°gina -->
        <div class="page-title">
            <h1>Gerenciamento de Pontos</h1>
            <p>Adicione ou remova pontos das crian√ßas de forma organizada</p>
        </div>

        <!-- Se√ß√£o 1: Adicionar Pontos com Atividades Positivas -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        <span class="professional-icon">‚ûï</span>
                        Adicionar Pontos
                    </div>
                    <div class="professional-card-subtitle">Atividades positivas que merecem reconhecimento</div>
                </div>
                <div class="professional-card-body">
                    <form id="add-positive-points-form" class="professional-form-grid">
                        <div class="professional-input-group">
                            <label for="positive-kid" class="professional-label">Crian√ßa</label>
                            <select id="positive-kid" name="kidId" required class="professional-select">
                                <option value="">Selecione uma crian√ßa</option>
                            </select>
                        </div>
                        <div class="professional-input-group">
                            <label for="positive-activity" class="professional-label">Atividade Positiva</label>
                            <select id="positive-activity" name="activityId" required class="professional-select">
                                <option value="">Selecione uma atividade</option>
                            </select>
                        </div>
                        <div class="professional-input-group">
                            <label for="positive-date" class="professional-label">Data da Atividade</label>
                            <input type="date" id="positive-date" name="date" class="professional-input"
                                title="Deixe em branco para usar a data atual">
                            <small class="professional-helper-text">Deixe em branco para usar hoje</small>
                        </div>
                        <div class="professional-input-group flex items-end">
                            <button type="submit" class="professional-button professional-button-success w-full">
                                <span class="professional-icon-small">‚ûï</span>
                                Adicionar Pontos
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o 2: Remover Pontos com Atividades Negativas -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        <span class="professional-icon">‚ûñ</span>
                        Remover Pontos
                    </div>
                    <div class="professional-card-subtitle">Atividades que precisam de corre√ß√£o</div>
                </div>
                <div class="professional-card-body">
                    <form id="remove-negative-points-form" class="professional-form-grid">
                        <div class="professional-input-group">
                            <label for="negative-kid" class="professional-label">Crian√ßa</label>
                            <select id="negative-kid" name="kidId" required class="professional-select">
                                <option value="">Selecione uma crian√ßa</option>
                            </select>
                        </div>
                        <div class="professional-input-group">
                            <label for="negative-activity" class="professional-label">Atividade Negativa</label>
                            <select id="negative-activity" name="activityId" required class="professional-select">
                                <option value="">Selecione uma atividade</option>
                            </select>
                        </div>
                        <div class="professional-input-group">
                            <label for="negative-date" class="professional-label">Data da Atividade</label>
                            <input type="date" id="negative-date" name="date" class="professional-input"
                                title="Deixe em branco para usar a data atual">
                            <small class="professional-helper-text">Deixe em branco para usar hoje</small>
                        </div>
                        <div class="professional-input-group flex items-end">
                            <button type="submit" class="professional-button professional-button-danger w-full">
                                <span class="professional-icon-small">‚ûñ</span>
                                Remover Pontos
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o 3: Adicionar Pontos Avulsos -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        <span class="professional-icon">‚≠ê</span>
                        Adicionar Pontos Avulsos
                    </div>
                    <div class="professional-card-subtitle">Reconhecimento personalizado para comportamentos especiais
                    </div>
                </div>
                <div class="professional-card-body">
                    <form id="add-custom-points-form" class="professional-form-grid-4">
                        <div class="professional-input-group">
                            <label for="custom-kid" class="professional-label">Crian√ßa</label>
                            <select id="custom-kid" name="kidId" required class="professional-select">
                                <option value="">Selecione uma crian√ßa</option>
                            </select>
                        </div>
                        <div class="professional-input-group">
                            <label for="custom-reason" class="professional-label">Motivo</label>
                            <input type="text" id="custom-reason" name="reason" placeholder="Ex: Comportamento exemplar"
                                required class="professional-input">
                        </div>
                        <div class="professional-input-group">
                            <label for="custom-points" class="professional-label">Quantidade de Pontos</label>
                            <input type="number" id="custom-points" name="points" min="1" max="500" placeholder="10"
                                required class="professional-input">
                        </div>
                        <div class="professional-input-group">
                            <label for="custom-date" class="professional-label">Data da Atividade</label>
                            <input type="date" id="custom-date" name="date" class="professional-input"
                                title="Deixe em branco para usar a data atual">
                            <small class="professional-helper-text">Deixe em branco para usar hoje</small>
                        </div>
                        <div class="professional-input-group flex items-end col-span-full">
                            <button type="submit" class="professional-button professional-button-success w-full">
                                <span class="professional-icon-small">‚≠ê</span>
                                Adicionar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o 4: Remover Pontos Avulsos -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        <span class="professional-icon">üíî</span>
                        Remover Pontos Avulsos
                    </div>
                    <div class="professional-card-subtitle">Corre√ß√£o personalizada para comportamentos inadequados</div>
                </div>
                <div class="professional-card-body">
                    <form id="remove-custom-points-form" class="professional-form-grid-4">
                        <div class="professional-input-group">
                            <label for="remove-kid" class="professional-label">Crian√ßa</label>
                            <select id="remove-kid" name="kidId" required class="professional-select">
                                <option value="">Selecione uma crian√ßa</option>
                            </select>
                        </div>
                        <div class="professional-input-group">
                            <label for="remove-reason" class="professional-label">Motivo</label>
                            <input type="text" id="remove-reason" name="reason"
                                placeholder="Ex: Comportamento inadequado" required class="professional-input">
                        </div>
                        <div class="professional-input-group">
                            <label for="remove-points" class="professional-label">Quantidade de Pontos</label>
                            <input type="number" id="remove-points" name="points" min="1" max="500" placeholder="5"
                                required class="professional-input">
                        </div>
                        <div class="professional-input-group">
                            <label for="remove-date" class="professional-label">Data da Atividade</label>
                            <input type="date" id="remove-date" name="date" class="professional-input"
                                title="Deixe em branco para usar a data atual">
                            <small class="professional-helper-text">Deixe em branco para usar hoje</small>
                        </div>
                        <div class="professional-input-group flex items-end col-span-full">
                            <button type="submit" class="professional-button professional-button-danger w-full">
                                <span class="professional-icon-small">üíî</span>
                                Remover
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>



        <!-- Resumo Atual -->
        <!-- Hist√≥rico de Atividades -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        üìä Hist√≥rico de Atividades
                    </div>
                    <div class="professional-card-subtitle">Acompanhe todas as atividades registradas</div>
                </div>
                <div class="professional-card-body">
                    <!-- Filtros -->
                    <div class="history-filters">
                        <div class="history-filters-grid">
                            <div class="history-filter-group">
                                <label for="filter-kid" class="history-filter-label">Crian√ßa</label>
                                <select id="filter-kid" class="history-filter-input">
                                    <option value="">Todas as crian√ßas</option>
                                </select>
                            </div>
                            <div class="history-filter-group">
                                <label for="filter-start-date" class="history-filter-label">Data In√≠cio</label>
                                <input type="date" id="filter-start-date" class="history-filter-input">
                            </div>
                            <div class="history-filter-group">
                                <label for="filter-end-date" class="history-filter-label">Data Fim</label>
                                <input type="date" id="filter-end-date" class="history-filter-input">
                            </div>
                            <div class="history-filter-group">
                                <button id="apply-filters-btn" onclick="applyFilters();"
                                    class="professional-button professional-button-secondary">
                                    üîç Filtrar
                                </button>
                            </div>
                            <div class="history-filter-group">
                                <button id="clear-filters-btn" onclick="clearFilters();"
                                    class="professional-button professional-button-tertiary">
                                    üóëÔ∏è Limpar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Cards de Hist√≥rico -->
                    <div id="history-cards" class="space-y-4">
                        <!-- Cards ser√£o carregados aqui -->
                    </div>

                    <!-- Estado vazio -->
                    <div id="history-empty" class="history-empty hidden">
                        <div class="history-empty-icon">üìù</div>
                        <h3>Nenhuma atividade registrada</h3>
                        <p>Comece a registrar atividades para ver o hist√≥rico aqui</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de Edi√ß√£o -->
    <div id="edit-point-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚úèÔ∏è Editar Registro</h3>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                    <span class="text-2xl">&times;</span>
                </button>
            </div>
            <form id="edit-point-form" class="space-y-4 mt-4">
                <input type="hidden" id="edit-point-id">

                <div class="professional-input-group">
                    <label for="edit-kid" class="professional-label">Crian√ßa</label>
                    <select id="edit-kid" name="kidId" class="professional-input" required>
                        <option value="">Selecione uma crian√ßa</option>
                        <!-- Crian√ßas ser√£o carregadas aqui -->
                    </select>
                </div>

                <div class="professional-input-group">
                    <label for="edit-date" class="professional-label">Data</label>
                    <input type="date" id="edit-date" name="date" class="professional-input" required>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeEditModal()"
                        class="professional-button professional-button-secondary">
                        Cancelar
                    </button>
                    <button type="submit" class="professional-button professional-button-primary">
                        Salvar Altera√ß√µes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Notifica√ß√£o -->
    <div id="notification-modal" class="modal hidden">
        <div class="modal-content">
            <div style="display: flex; align-items: center; margin-bottom: 16px;">
                <div id="notification-icon" style="margin-right: 12px; font-size: 24px;"></div>
                <h3 id="notification-title" class="modal-title"></h3>
            </div>
            <p id="notification-message" class="modal-message"></p>
            <div style="text-align: right;">
                <button id="notification-close" class="modal-button">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script src="js/toast.js"></script>
    <script>
        // Vari√°veis globais
        let positiveActivities = [];
        let negativeActivities = [];

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function () {
            // Verificar autentica√ß√£o
            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('Erro', 'Usu√°rio n√£o autenticado. Redirecionando para login...', 'error');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
                return;
            }

            loadData();
        });

        // Carregar dados
        async function loadData() {
            try {
                await Promise.all([
                    loadKids(),
                    loadActivities()
                ]);

                // Configurar m√™s padr√£o e carregar hist√≥rico
                setCurrentMonthDefault();
                await loadHistory();
            } catch (error) {
                showNotification('Erro', 'Erro ao carregar dados: ' + error.message, 'error');
            }
        }

        // Carregar crian√ßas
        async function loadKids() {
            try {
                const response = await API.get('/kids');
                kids = response.data.kids || [];
                updateKidsSelects();
            } catch (error) {
                showNotification('Erro', 'Erro ao carregar crian√ßas: ' + error.message, 'error');
            }
        }

        // Carregar atividades
        async function loadActivities() {
            try {
                const response = await API.get('/activities');

                const allActivities = response.data.activities || [];

                // Separar atividades positivas e negativas pelo campo type e ordenar alfabeticamente
                positiveActivities = allActivities.filter(activity => activity.type === 'positive')
                    .sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));
                negativeActivities = allActivities.filter(activity => activity.type === 'negative')
                    .sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));

                updateActivitySelects();
            } catch (error) {
                showNotification('Error', 'Erro ao carregar atividades: ' + error.message, 'error');
            }
        }

        // Atualizar selects de crian√ßas
        function updateKidsSelects() {
            const selects = ['positive-kid', 'negative-kid', 'custom-kid', 'remove-kid'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) {
                    return;
                }

                select.innerHTML = '<option value="">Selecione uma crian√ßa</option>';

                if (kids && kids.length > 0) {
                    kids.forEach(kid => {
                        const option = document.createElement('option');
                        option.value = kid._id;
                        option.textContent = `${kid.name} (${kid.age} anos)`;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Atualizar selects de atividades
        function updateActivitySelects() {
            // Atividades positivas
            const positiveSelect = document.getElementById('positive-activity');
            if (positiveSelect) {
                positiveSelect.innerHTML = '<option value="">Selecione uma atividade</option>';
                if (positiveActivities && positiveActivities.length > 0) {
                    positiveActivities.forEach(activity => {
                        const option = document.createElement('option');
                        option.value = activity._id;
                        option.setAttribute('data-points', activity.points);
                        option.textContent = `${activity.icon || 'üéØ'} ${activity.name} (${activity.points} pts)`;
                        positiveSelect.appendChild(option);
                    });
                }
            }

            // Atividades negativas
            const negativeSelect = document.getElementById('negative-activity');
            if (negativeSelect) {
                negativeSelect.innerHTML = '<option value="">Selecione uma atividade</option>';
                if (negativeActivities && negativeActivities.length > 0) {
                    negativeActivities.forEach(activity => {
                        const option = document.createElement('option');
                        option.value = activity._id;
                        option.setAttribute('data-points', activity.points);
                        option.textContent = `${activity.icon || '‚ö†Ô∏è'} ${activity.name} (${activity.points} pts)`;
                        negativeSelect.appendChild(option);
                    });
                }
            }
        }



        // Event listeners para formul√°rios
        document.getElementById('add-positive-points-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            await submitPointsForm(this, 'add');
        });

        document.getElementById('remove-negative-points-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            await submitPointsForm(this, 'remove');
        });

        document.getElementById('add-custom-points-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            await submitCustomPointsForm(this, 'add');
        });

        document.getElementById('remove-custom-points-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            await submitCustomPointsForm(this, 'remove');
        });

        // Submeter formul√°rio de pontos com atividades
        async function submitPointsForm(form, action) {
            const formData = new FormData(form);
            const customDate = formData.get('date');

            const data = {
                kidId: formData.get('kidId'),
                activityId: formData.get('activityId'),
                notes: `Atividade ${action === 'add' ? 'positiva' : 'negativa'}`
            };

            // Adicionar data personalizada se fornecida
            if (customDate) {
                data.date = customDate;
            }

            try {
                const endpoint = action === 'add' ? '/points/add' : '/points/remove';
                const response = await API.post(endpoint, data);

                showToast('Sucesso', `Pontos ${action === 'add' ? 'adicionados' : 'removidos'} com sucesso!`, 'success');
                form.reset();
                loadHistory();
            } catch (error) {
                showToast('Erro', error.message, 'error');
            }
        }

        // Submeter formul√°rio de pontos avulsos
        async function submitCustomPointsForm(form, action) {
            const formData = new FormData(form);
            const customDate = formData.get('date');

            const data = {
                kidId: formData.get('kidId'),
                reason: formData.get('reason'),
                points: parseInt(formData.get('points')),
                notes: `Pontos ${action === 'add' ? 'adicionados' : 'removidos'} avulsos`
            };

            // Adicionar data personalizada se fornecida
            if (customDate) {
                data.date = customDate;
            }

            try {
                const endpoint = action === 'add' ? '/points/add' : '/points/remove';
                const response = await API.post(endpoint, data);

                showToast('Sucesso', `Pontos ${action === 'add' ? 'adicionados' : 'removidos'} com sucesso!`, 'success');
                form.reset();
                loadHistory();
            } catch (error) {
                showToast('Erro', error.message, 'error');
            }
        }



        // Fun√ß√£o para mostrar notifica√ß√£o
        function showNotification(title, message, type = 'info') {
            const modal = document.getElementById('notification-modal');
            const icon = document.getElementById('notification-icon');
            const titleEl = document.getElementById('notification-title');
            const messageEl = document.getElementById('notification-message');

            titleEl.textContent = title;
            messageEl.textContent = message;

            // Definir √≠cone baseado no tipo
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            icon.textContent = icons[type] || icons.info;

            modal.classList.remove('hidden');

            // Fechar modal ao clicar em OK
            document.getElementById('notification-close').onclick = function () {
                modal.classList.add('hidden');
            };
        }
    </script>
</body>

</html>