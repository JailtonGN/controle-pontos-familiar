<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Pontos - Controle de Pontos Familiar</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/png" href="assets/logo.png">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-content">
                <!-- Brand -->
                <div class="navbar-brand">
                    <div class="navbar-logo"></div>
                    <div>
                        <div class="navbar-title">Gerenciar Pontos</div>
                        <div class="navbar-subtitle">Sistema de Pontos</div>
                    </div>
                </div>

                <!-- Desktop Menu -->
                <div class="navbar-menu">
                    <div class="navbar-item">
                        <a href="/dashboard" class="navbar-button" id="nav-dashboard">
                            <span class="navbar-button-text">Tela Inicial</span>
                        </a>
                    </div>
                    <div class="navbar-item">
                        <a href="/manage-points" class="navbar-button active" id="nav-activities">
                            <span class="navbar-button-text">Atividades</span>
                        </a>
                    </div>
                    <div class="navbar-item">
                        <a href="/kids" class="navbar-button" id="nav-kids">
                            <span class="navbar-button-text">Cadastros</span>
                        </a>
                    </div>
                    <div class="navbar-item">
                        <a href="/communication" class="navbar-button" id="nav-communication">
                            <span class="navbar-button-text">Comunicação</span>
                        </a>
                    </div>
                    <div class="navbar-item">
                        <a href="/settings" class="navbar-button" id="nav-settings">
                            <span class="navbar-button-text">Configuração</span>
                        </a>
                    </div>
                </div>

                <!-- User Menu -->
                <div class="navbar-user">
                    <span id="user-name" class="navbar-user-name"></span>
                    <button onclick="logout()" class="navbar-button navbar-button-logout">
                        Sair
                    </button>
                </div>

                <!-- Mobile Menu Button -->
                <div class="navbar-mobile-menu">
                    <button class="navbar-mobile-button" onclick="toggleMobileMenu()">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile Menu -->
            <div id="mobile-menu" class="navbar-mobile-menu-content hidden">
                <a href="/dashboard" class="navbar-mobile-item" onclick="setActiveNav('nav-dashboard')">
                    Tela Inicial
                </a>
                <a href="/manage-points" class="navbar-mobile-item active" onclick="setActiveNav('nav-activities')">
                    Atividades
                </a>
                <a href="/kids" class="navbar-mobile-item" onclick="setActiveNav('nav-kids')">
                    Cadastros
                </a>
                <a href="/communication" class="navbar-mobile-item" onclick="setActiveNav('nav-communication')">
                    Comunicação
                </a>
                <a href="/settings" class="navbar-mobile-item" onclick="setActiveNav('nav-settings')">
                    Configuração
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container" style="padding-top: 32px; padding-bottom: 32px;">
        <!-- Título da Página -->
        <div class="page-title">
            <h1>Gerenciamento de Pontos</h1>
            <p>Adicione ou remova pontos das crianças de forma organizada</p>
        </div>

        <!-- Seção 1: Adicionar Pontos com Atividades Positivas -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        <span class="professional-icon">➕</span>
                        Adicionar Pontos
                    </div>
                    <div class="professional-card-subtitle">Atividades positivas que merecem reconhecimento</div>
                </div>
                <div class="professional-card-body">
                    <form id="add-positive-points-form" class="professional-form-grid">
                        <div class="professional-input-group">
                            <label for="positive-kid" class="professional-label">Criança</label>
                            <select id="positive-kid" name="kidId" required class="professional-select">
                                <option value="">Selecione uma criança</option>
                            </select>
                        </div>
                        <div class="professional-input-group">
                            <label for="positive-activity" class="professional-label">Atividade Positiva</label>
                            <select id="positive-activity" name="activityId" required class="professional-select">
                                <option value="">Selecione uma atividade</option>
                            </select>
                        </div>
                        <div class="professional-input-group flex items-end">
                            <button type="submit" class="professional-button professional-button-success w-full">
                                <span class="professional-icon-small">➕</span>
                                Adicionar Pontos
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Seção 2: Remover Pontos com Atividades Negativas -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        <span class="professional-icon">➖</span>
                        Remover Pontos
                    </div>
                    <div class="professional-card-subtitle">Atividades que precisam de correção</div>
                </div>
                <div class="professional-card-body">
                    <form id="remove-negative-points-form" class="professional-form-grid">
                        <div class="professional-input-group">
                            <label for="negative-kid" class="professional-label">Criança</label>
                            <select id="negative-kid" name="kidId" required class="professional-select">
                                <option value="">Selecione uma criança</option>
                            </select>
                        </div>
                        <div class="professional-input-group">
                            <label for="negative-activity" class="professional-label">Atividade Negativa</label>
                            <select id="negative-activity" name="activityId" required class="professional-select">
                                <option value="">Selecione uma atividade</option>
                            </select>
                        </div>
                        <div class="professional-input-group flex items-end">
                            <button type="submit" class="professional-button professional-button-danger w-full">
                                <span class="professional-icon-small">➖</span>
                                Remover Pontos
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Seção 3: Adicionar Pontos Avulsos -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        <span class="professional-icon">⭐</span>
                        Adicionar Pontos Avulsos
                    </div>
                    <div class="professional-card-subtitle">Reconhecimento personalizado para comportamentos especiais</div>
                </div>
                <div class="professional-card-body">
                    <form id="add-custom-points-form" class="professional-form-grid-4">
                        <div class="professional-input-group">
                            <label for="custom-kid" class="professional-label">Criança</label>
                            <select id="custom-kid" name="kidId" required class="professional-select">
                                <option value="">Selecione uma criança</option>
                            </select>
                        </div>
                        <div class="professional-input-group">
                            <label for="custom-reason" class="professional-label">Motivo</label>
                            <input type="text" id="custom-reason" name="reason" placeholder="Ex: Comportamento exemplar" required class="professional-input">
                        </div>
                        <div class="professional-input-group">
                            <label for="custom-points" class="professional-label">Quantidade de Pontos</label>
                            <input type="number" id="custom-points" name="points" min="1" max="100" placeholder="10" required class="professional-input">
                        </div>
                        <div class="professional-input-group flex items-end">
                            <button type="submit" class="professional-button professional-button-success w-full">
                                <span class="professional-icon-small">⭐</span>
                                Adicionar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Seção 4: Remover Pontos Avulsos -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        <span class="professional-icon">💔</span>
                        Remover Pontos Avulsos
                    </div>
                    <div class="professional-card-subtitle">Correção personalizada para comportamentos inadequados</div>
                </div>
                <div class="professional-card-body">
                    <form id="remove-custom-points-form" class="professional-form-grid-4">
                        <div class="professional-input-group">
                            <label for="remove-kid" class="professional-label">Criança</label>
                            <select id="remove-kid" name="kidId" required class="professional-select">
                                <option value="">Selecione uma criança</option>
                            </select>
                        </div>
                        <div class="professional-input-group">
                            <label for="remove-reason" class="professional-label">Motivo</label>
                            <input type="text" id="remove-reason" name="reason" placeholder="Ex: Comportamento inadequado" required class="professional-input">
                        </div>
                        <div class="professional-input-group">
                            <label for="remove-points" class="professional-label">Quantidade de Pontos</label>
                            <input type="number" id="remove-points" name="points" min="1" max="100" placeholder="5" required class="professional-input">
                        </div>
                        <div class="professional-input-group flex items-end">
                            <button type="submit" class="professional-button professional-button-danger w-full">
                                <span class="professional-icon-small">💔</span>
                                Remover
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>



        <!-- Resumo Atual -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        <span class="professional-icon">📊</span>
                        Resumo Atual
                    </div>
                    <div class="professional-card-subtitle">Pontuação atual de todas as crianças</div>
                </div>
                <div class="professional-card-body">
                    <div id="current-summary" class="professional-summary-grid">
                        <!-- Resumo será carregado aqui -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de Notificação -->
    <div id="notification-modal" class="modal hidden">
        <div class="modal-content">
            <div style="display: flex; align-items: center; margin-bottom: 16px;">
                <div id="notification-icon" style="margin-right: 12px; font-size: 24px;"></div>
                <h3 id="notification-title" class="modal-title"></h3>
            </div>
            <p id="notification-message" class="modal-message"></p>
            <div style="text-align: right;">
                <button id="notification-close" class="modal-button">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        // Variáveis globais
        let positiveActivities = [];
        let negativeActivities = [];

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Página manage-points carregada');
            
            // Verificar autenticação
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('Usuário não autenticado');
                showNotification('Erro', 'Usuário não autenticado. Redirecionando para login...', 'error');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
                return;
            }
            
            console.log('Usuário autenticado, carregando dados...');
            loadData();
        });

        // Carregar dados
        async function loadData() {
            try {
                console.log('Iniciando carregamento de dados...');
                await Promise.all([
                    loadKids(),
                    loadActivities(),
                    loadCurrentSummary()
                ]);
                console.log('Dados carregados com sucesso');
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showNotification('Erro', 'Erro ao carregar dados: ' + error.message, 'error');
            }
        }

        // Carregar crianças
        async function loadKids() {
            try {
                console.log('Carregando crianças...');
                
                const response = await API.get('/kids');
                console.log('Resposta da API via classe API:', response);
                kids = response.data.kids || [];
                console.log('Crianças carregadas:', kids);
                updateKidsSelects();
            } catch (error) {
                console.error('Erro ao carregar crianças:', error);
                showNotification('Erro', 'Erro ao carregar crianças: ' + error.message, 'error');
            }
        }

        // Carregar atividades
        async function loadActivities() {
            try {
                console.log('Carregando atividades...');
                const response = await API.get('/activities');
                console.log('Resposta da API de atividades:', response);
                
                const allActivities = response.data.activities || [];
                console.log('Todas as atividades:', allActivities);
                
                // Separar atividades positivas e negativas pelo campo type
                positiveActivities = allActivities.filter(activity => activity.type === 'positive');
                negativeActivities = allActivities.filter(activity => activity.type === 'negative');
                
                console.log('Atividades positivas:', positiveActivities);
                console.log('Atividades negativas:', negativeActivities);
                
                updateActivitySelects();
            } catch (error) {
                console.error('Erro ao carregar atividades:', error);
                showNotification('Erro', 'Erro ao carregar atividades: ' + error.message, 'error');
            }
        }

        // Atualizar selects de crianças
        function updateKidsSelects() {
            console.log('Atualizando selects de crianças...');
            console.log('Crianças disponíveis:', kids);
            
            const selects = ['positive-kid', 'negative-kid', 'custom-kid', 'remove-kid'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) {
                    console.error(`Select ${selectId} não encontrado`);
                    return;
                }
                
                select.innerHTML = '<option value="">Selecione uma criança</option>';
                
                if (kids && kids.length > 0) {
                    kids.forEach(kid => {
                        const option = document.createElement('option');
                        option.value = kid._id;
                        option.textContent = `${kid.name} (${kid.age} anos)`;
                        select.appendChild(option);
                    });
                    console.log(`Select ${selectId} atualizado com ${kids.length} crianças`);
                } else {
                    console.log(`Nenhuma criança disponível para ${selectId}`);
                }
            });
        }

        // Atualizar selects de atividades
        function updateActivitySelects() {
            console.log('Atualizando selects de atividades...');
            
            // Atividades positivas
            const positiveSelect = document.getElementById('positive-activity');
            if (positiveSelect) {
                positiveSelect.innerHTML = '<option value="">Selecione uma atividade</option>';
                if (positiveActivities && positiveActivities.length > 0) {
                    positiveActivities.forEach(activity => {
                        const option = document.createElement('option');
                        option.value = activity._id;
                        option.setAttribute('data-points', activity.points);
                        option.textContent = `${activity.icon || '🎯'} ${activity.name} (${activity.points} pts)`;
                        positiveSelect.appendChild(option);
                    });
                    console.log(`Select de atividades positivas atualizado com ${positiveActivities.length} atividades`);
                } else {
                    console.log('Nenhuma atividade positiva disponível');
                }
            } else {
                console.error('Select positive-activity não encontrado');
            }

            // Atividades negativas
            const negativeSelect = document.getElementById('negative-activity');
            if (negativeSelect) {
                negativeSelect.innerHTML = '<option value="">Selecione uma atividade</option>';
                if (negativeActivities && negativeActivities.length > 0) {
                    negativeActivities.forEach(activity => {
                        const option = document.createElement('option');
                        option.value = activity._id;
                        option.setAttribute('data-points', activity.points);
                        option.textContent = `${activity.icon || '⚠️'} ${activity.name} (${activity.points} pts)`;
                        negativeSelect.appendChild(option);
                    });
                    console.log(`Select de atividades negativas atualizado com ${negativeActivities.length} atividades`);
                } else {
                    console.log('Nenhuma atividade negativa disponível');
                }
            } else {
                console.error('Select negative-activity não encontrado');
            }
        }

        // Carregar resumo atual
        async function loadCurrentSummary() {
            try {
                const response = await API.get('/kids');
                const kidsData = response.data.kids;
                
                                 const summaryContainer = document.getElementById('current-summary');
                 summaryContainer.innerHTML = kidsData.map(kid => `
                     <div class="professional-summary-card">
                         <div class="professional-summary-header">
                             <div>
                                 <div class="professional-summary-name">${kid.name}</div>
                                 <div class="professional-summary-age">${kid.age} anos</div>
                             </div>
                             <div class="text-right">
                                 <div class="professional-summary-points">${kid.totalPoints ?? 0}</div>
                                 <div class="professional-summary-label">pontos</div>
                             </div>
                         </div>
                     </div>
                 `).join('');
            } catch (error) {
                console.error('Erro ao carregar resumo:', error);
            }
        }

        // Event listeners para formulários
        document.getElementById('add-positive-points-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            await submitPointsForm(this, 'add');
        });

        document.getElementById('remove-negative-points-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            await submitPointsForm(this, 'remove');
        });

        document.getElementById('add-custom-points-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            await submitCustomPointsForm(this, 'add');
        });

        document.getElementById('remove-custom-points-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            await submitCustomPointsForm(this, 'remove');
        });

        // Submeter formulário de pontos com atividades
        async function submitPointsForm(form, action) {
            const formData = new FormData(form);
            const data = {
                kidId: formData.get('kidId'),
                activityId: formData.get('activityId'),
                notes: `Atividade ${action === 'add' ? 'positiva' : 'negativa'}`
            };

            try {
                const endpoint = action === 'add' ? '/points/add' : '/points/remove';
                const response = await API.post(endpoint, data);
                
                showNotification('Sucesso', `Pontos ${action === 'add' ? 'adicionados' : 'removidos'} com sucesso!`, 'success');
                form.reset();
                loadCurrentSummary();
            } catch (error) {
                showNotification('Erro', error.message, 'error');
            }
        }

        // Submeter formulário de pontos avulsos
        async function submitCustomPointsForm(form, action) {
            const formData = new FormData(form);
            const data = {
                kidId: formData.get('kidId'),
                reason: formData.get('reason'),
                points: parseInt(formData.get('points')),
                notes: `Pontos ${action === 'add' ? 'adicionados' : 'removidos'} avulsos`
            };

            try {
                const endpoint = action === 'add' ? '/points/add' : '/points/remove';
                const response = await API.post(endpoint, data);
                
                showNotification('Sucesso', `Pontos ${action === 'add' ? 'adicionados' : 'removidos'} com sucesso!`, 'success');
                form.reset();
                loadCurrentSummary();
            } catch (error) {
                showNotification('Erro', error.message, 'error');
            }
        }



        // Função para mostrar notificação
        function showNotification(title, message, type = 'info') {
            const modal = document.getElementById('notification-modal');
            const icon = document.getElementById('notification-icon');
            const titleEl = document.getElementById('notification-title');
            const messageEl = document.getElementById('notification-message');

            titleEl.textContent = title;
            messageEl.textContent = message;

            // Definir ícone baseado no tipo
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            icon.textContent = icons[type] || icons.info;

            modal.classList.remove('hidden');

            // Fechar modal ao clicar em OK
            document.getElementById('notification-close').onclick = function() {
                modal.classList.add('hidden');
            };
        }
    </script>
</body>
</html> 