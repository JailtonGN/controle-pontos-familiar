<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√µes - Controle de Pontos Familiar</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/png" href="assets/logo.png">
    <!-- Offline Mode Support -->
    <script src="vendor/jspdf.umd.min.js"></script>
    <script src="vendor/jspdf.plugin.autotable.min.js"></script>
    <style>
        .required {
            color: #dc3545;
            font-weight: bold;
        }
        
        .form-group label.required::after {
            content: " *";
            color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- Modern Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-content">
                <!-- Brand -->
                <div class="navbar-brand">
                    <div class="navbar-logo"></div>
                    <div>
                        <div class="navbar-title">Configura√ß√µes</div>
                        <div class="navbar-subtitle">Sistema de Pontos</div>
                    </div>
                </div>

                <!-- Desktop Menu -->
                <div class="navbar-menu">
                    <div class="navbar-item">
                        <a href="/dashboard" class="navbar-button" id="nav-dashboard">
                            <span class="navbar-button-text">Tela Inicial</span>
                        </a>
                    </div>
                    <div class="navbar-item">
                        <a href="/manage-points" class="navbar-button" id="nav-activities">
                            <span class="navbar-button-text">Atividades</span>
                        </a>
                    </div>
                    <div class="navbar-item">
                        <a href="/kids" class="navbar-button" id="nav-kids">
                            <span class="navbar-button-text">Cadastros</span>
                        </a>
                    </div>
                    <div class="navbar-item">
                        <a href="/communication" class="navbar-button" id="nav-communication">
                            <span class="navbar-button-text">Comunica√ß√£o</span>
                        </a>
                    </div>
                    <div class="navbar-item">
                        <a href="/config" class="navbar-button active" id="nav-settings">
                            <span class="navbar-button-text">Configura√ß√£o</span>
                        </a>
                    </div>
                </div>

                <!-- User Menu -->
                <div class="navbar-user">
                    <span id="user-name" class="navbar-user-name"></span>
                    <button onclick="logout()" class="navbar-button navbar-button-logout">
                        Sair
                    </button>
                </div>

                <!-- Mobile Menu Button -->
                <div class="navbar-mobile-menu">
                    <button class="navbar-mobile-button" onclick="toggleMobileMenu()">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile Menu -->
            <div id="mobile-menu" class="navbar-mobile-menu-content hidden">
                <a href="/dashboard" class="navbar-mobile-item" onclick="setActiveNav('nav-dashboard')">
                    Tela Inicial
                </a>
                <a href="/manage-points" class="navbar-mobile-item" onclick="setActiveNav('nav-activities')">
                    Atividades
                </a>
                <a href="/kids" class="navbar-mobile-item" onclick="setActiveNav('nav-kids')">
                    Cadastros
                </a>
                <a href="/communication" class="navbar-mobile-item" onclick="setActiveNav('nav-communication')">
                    Comunica√ß√£o
                </a>
                <a href="/config" class="navbar-mobile-item active" onclick="setActiveNav('nav-settings')">
                    Configura√ß√£o
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container config-container" style="padding-top: 32px; padding-bottom: 32px;">
        
        <!-- Se√ß√£o de Perfil -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        üë§ Perfil do Usu√°rio
                    </div>
                </div>
                <div class="professional-card-content">
                    <div class="profile-info">
                        <div class="profile-avatar">üë§</div>
                        <div class="profile-details">
                            <h3 id="profile-name">Carregando...</h3>
                            <p id="profile-email">carregando@email.com</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Seguran√ßa -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        üîí Seguran√ßa
                    </div>
                </div>
                <div class="professional-card-content">
                    <h3>Alterar Senha</h3>
                    <form id="change-password-form" class="config-form">
                        <div class="form-group">
                            <label for="current-password">Senha Atual</label>
                            <input type="password" id="current-password" required>
                        </div>
                        <div class="form-group">
                            <label for="new-password">Nova Senha</label>
                            <input type="password" id="new-password" required>
                        </div>
                        <div class="form-group">
                            <label for="confirm-new-password">Confirmar Nova Senha</label>
                            <input type="password" id="confirm-new-password" required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span class="loading-spinner hidden"></span>
                            <span class="button-text">Alterar Senha</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Dados -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        üìä Gerenciamento de Dados
                    </div>
                </div>
                <div class="professional-card-content">
                    <!-- Aba de Registro (somente admin) -->
                    <div id="admin-register-card" class="config-card" style="display:none;">
                        <h3>üë§ Registro de Usu√°rios (Admin)</h3>
                        <p>Crie novos usu√°rios. Dispon√≠vel apenas para administradores.</p>
                        <form id="admin-register-form" class="config-form">
                            <div class="form-group">
                                <label for="admin-register-name">Nome</label>
                                <input type="text" id="admin-register-name" required>
                            </div>
                            <div class="form-group">
                                <label for="admin-register-email">Email</label>
                                <input type="email" id="admin-register-email" required>
                            </div>
                            <div class="form-group">
                                <label for="admin-register-password">Senha</label>
                                <input type="password" id="admin-register-password" required>
                            </div>
                            <div class="form-group">
                                <label for="admin-register-role">Perfil</label>
                                <select id="admin-register-role">
                                    <option value="parent">Pai/M√£e</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="admin-register-family">Fam√≠lia</label>
                                <select id="admin-register-family">
                                    <option value="">Sem Fam√≠lia</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <span class="loading-spinner hidden"></span>
                                <span class="button-text">Criar Usu√°rio</span>
                            </button>
                        </form>
                    </div>

                    <!-- Aba de Gerenciamento de Fam√≠lias (somente admin) -->
                    <div id="admin-families-card" class="professional-card" style="display:none;">
                        <div class="professional-card-header">
                            <div class="professional-card-title">
                                üè† Gerenciamento de Fam√≠lias (Admin)
                            </div>
                        </div>
                        <div class="professional-card-content">
                            <p>Gerencie fam√≠lias no sistema. Dispon√≠vel apenas para administradores.</p>
                            
                            <!-- Formul√°rio para criar nova fam√≠lia -->
                            <div class="family-form-section">
                                <h3>‚ûï Nova Fam√≠lia</h3>
                                <form id="family-form" class="config-form">
                                    <div class="form-group">
                                        <label for="family-name">Nome da Fam√≠lia</label>
                                        <input type="text" id="family-name" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="family-description">Descri√ß√£o (opcional)</label>
                                        <textarea id="family-description" rows="3"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <span class="loading-spinner hidden"></span>
                                        <span class="button-text">Criar Fam√≠lia</span>
                                    </button>
                                </form>
                            </div>

                            <!-- Lista de fam√≠lias -->
                            <div class="families-list-section">
                                <h3>üìã Fam√≠lias Existentes</h3>
                            <div id="families-table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Descri√ß√£o</th>
                                            <th>Membros</th>
                                            <th>Crian√ßas</th>
                                            <th>Criada em</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="families-table-body">
                                        <!-- Fam√≠lias ser√£o carregadas aqui -->
                                    </tbody>
                                </table>
                            </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Apagar Pontos -->
                    <div class="config-card danger">
                        <h3>üóëÔ∏è Apagar Todos os Pontos</h3>
                        <p class="warning-text">‚ö†Ô∏è Esta a√ß√£o ir√° remover TODOS os pontos de TODAS as crian√ßas. Esta a√ß√£o n√£o pode ser desfeita!</p>
                        <button onclick="confirmDeletePoints()" class="btn btn-danger">
                            Apagar Todos os Pontos
                        </button>
                    </div>

                    <!-- Apagar Hist√≥rico -->
                    <div class="config-card danger">
                        <h3>üóëÔ∏è Apagar Hist√≥rico Completo</h3>
                        <p class="warning-text">‚ö†Ô∏è Esta a√ß√£o ir√° remover TODO o hist√≥rico de pontos. Esta a√ß√£o n√£o pode ser desfeita!</p>
                        <button onclick="confirmDeleteHistory()" class="btn btn-danger">
                            Apagar Hist√≥rico Completo
                        </button>
                    </div>

                                         <!-- Baixar Hist√≥rico -->
                     <div class="config-card">
                         <h3>üìÑ Baixar Hist√≥rico em PDF</h3>
                         <p>Baixe o hist√≥rico de pontos organizado por crian√ßa e m√™s</p>
                         <div class="form-group">
                             <label for="history-month">Selecionar M√™s:</label>
                             <select id="history-month" class="form-control">
                                 <option value="">Carregando...</option>
                             </select>
                         </div>
                         <div class="form-group">
                             <label for="history-kid">Selecionar Crian√ßa (opcional):</label>
                             <select id="history-kid" class="form-control">
                                 <option value="">Todas as crian√ßas</option>
                             </select>
                         </div>
                         <button onclick="downloadHistoryPDF()" class="btn btn-secondary">
                             üìÑ Baixar Hist√≥rico
                         </button>
                     </div>

                                         <!-- Baixar Atividades -->
                     <div class="config-card">
                         <h3>üìã Baixar Relat√≥rio de Atividades</h3>
                         <p>Baixe um relat√≥rio completo de todas as atividades cadastradas</p>
                         <div class="form-group">
                             <label for="activities-filter">Filtrar por tipo:</label>
                             <select id="activities-filter" class="form-control">
                                 <option value="all">Todas as atividades</option>
                                 <option value="positive">Apenas positivas</option>
                                 <option value="negative">Apenas negativas</option>
                             </select>
                         </div>
                         <button onclick="downloadActivitiesPDF()" class="btn btn-secondary">
                             üìã Baixar Atividades
                         </button>
                     </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Estat√≠sticas -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        üìà Estat√≠sticas do Sistema
                    </div>
                </div>
                <div class="professional-card-content">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="total-kids">-</div>
                            <div class="stat-label">Crian√ßas Cadastradas</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="total-activities">-</div>
                            <div class="stat-label">Atividades Cadastradas</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="total-points">-</div>
                            <div class="stat-label">Total de Pontos</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="total-records">-</div>
                            <div class="stat-label">Registros de Pontos</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Gerenciamento de Usu√°rios (Admin) -->
        <div id="admin-users-section" class="professional-section" style="display:none;">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        üë• Gerenciamento de Usu√°rios (Admin)
                    </div>
                </div>
                <div class="professional-card-content">
                    <div class="users-controls">
                        <button onclick="showAddUserModal()" class="btn btn-primary">
                            ‚ûï Novo Usu√°rio
                        </button>
                    </div>
                    
                    <div class="users-table-container">
                        <table class="users-table">
                                                                <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Email</th>
                                            <th>Perfil</th>
                                            <th>Status</th>
                                            <th>Fam√≠lia</th>
                                            <th>√öltimo Login</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                            <tbody id="users-table-body">
                                <!-- Usu√°rios ser√£o carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Modal Adicionar/Editar Usu√°rio -->
    <div id="user-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="user-modal-title">Adicionar Usu√°rio</h3>
                <button onclick="closeModal('user-modal')" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="user-form" class="config-form">
                    <div class="form-group">
                        <label for="user-name">Nome</label>
                        <input type="text" id="user-name" required>
                    </div>
                    <div class="form-group">
                        <label for="user-email">Email</label>
                        <input type="email" id="user-email" required>
                    </div>
                    <div class="form-group">
                        <label for="user-password">Senha</label>
                        <input type="password" id="user-password" required>
                    </div>
                    <div class="form-group">
                        <label for="user-role">Perfil</label>
                        <select id="user-role">
                            <option value="parent">Pai/M√£e</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="user-status">Status</label>
                        <select id="user-status">
                            <option value="true">Ativo</option>
                            <option value="false">Inativo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="user-family">Fam√≠lia <span class="required">*</span></label>
                        <select id="user-family" required>
                            <option value="">Selecione uma fam√≠lia</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('user-modal')" class="btn btn-secondary">Cancelar</button>
                <button onclick="saveUser()" class="btn btn-primary">
                    <span class="loading-spinner hidden"></span>
                    <span class="button-text">Salvar</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Exclus√£o -->
    <div id="delete-user-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirmar Exclus√£o</h3>
                <button onclick="closeModal('delete-user-modal')" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o usu√°rio <strong id="delete-user-name"></strong>?</p>
                <p class="warning-text">‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita e remover√° todos os dados associados.</p>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('delete-user-modal')" class="btn btn-secondary">Cancelar</button>
                <button onclick="confirmDeleteUser()" class="btn btn-danger">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o Gen√©rico -->
    <div id="confirm-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Confirmar A√ß√£o</h3>
                <button onclick="closeModal('confirm-modal')" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modal-message">Tem certeza que deseja realizar esta a√ß√£o?</p>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('confirm-modal')" class="btn btn-secondary">Cancelar</button>
                <button id="modal-confirm-btn" class="btn btn-primary">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de edi√ß√£o de fam√≠lia -->
    <div id="edit-family-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="edit-family-modal-title">‚úèÔ∏è Editar Fam√≠lia</h3>
                <button onclick="closeModal('edit-family-modal')" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-family-form" class="config-form">
                    <div class="form-group">
                        <label for="edit-family-name">Nome da Fam√≠lia</label>
                        <input type="text" id="edit-family-name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-family-description">Descri√ß√£o (opcional)</label>
                        <textarea id="edit-family-description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('edit-family-modal')" class="btn btn-secondary">Cancelar</button>
                <button onclick="saveFamily()" class="btn btn-primary">
                    <span class="loading-spinner hidden"></span>
                    <span class="button-text">Salvar</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de exclus√£o de fam√≠lia -->
    <div id="delete-family-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üóëÔ∏è Confirmar Exclus√£o de Fam√≠lia</h3>
                <button onclick="closeModal('delete-family-modal')" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir a fam√≠lia <strong id="delete-family-name"></strong>?</p>
                <p class="warning-text">‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita! Todos os usu√°rios e crian√ßas da fam√≠lia ficar√£o sem fam√≠lia.</p>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('delete-family-modal')" class="btn btn-secondary">Cancelar</button>
                <button onclick="confirmDeleteFamily()" class="btn btn-danger">Excluir Fam√≠lia</button>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script src="js/toast.js"></script>
    <script>
        // Client-side logic for config page
        // Carregar dados da p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            setActiveNav('nav-settings');
            setupAdminRegisterIfAllowed();
            loadUserProfile();
            loadStats();
            
            // Popular dropdowns para filtros de PDF
            populateMonthSelect();
            populateKidsSelect();
            
            // Fam√≠lias ser√£o carregadas apenas se for admin (na fun√ß√£o loadUserProfile)
        });

        // Carregar perfil do usu√°rio
        async function loadUserProfile() {
            try {
                console.log('üë§ [CONFIG] Carregando perfil do usu√°rio...');
                const token = localStorage.getItem('token');
                if (!token) {
                    console.log('‚ùå [CONFIG] Token n√£o encontrado, redirecionando...');
                    window.location.href = '/';
                    return;
                }

                const response = await fetch('/api/auth/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('üì° [CONFIG] Resposta do perfil:', response.status, response.statusText);

                if (response.ok) {
                    const data = await response.json();
                    console.log('üìÑ [CONFIG] Dados do perfil:', data);
                    
                    if (data.success && data.data && data.data.user) {
                        const user = data.data.user;
                        console.log('üë§ [CONFIG] Usu√°rio carregado:', { name: user.name, email: user.email, role: user.role });
                        
                        document.getElementById('user-name').textContent = user.name;
                        document.getElementById('profile-name').textContent = user.name;
                        document.getElementById('profile-email').textContent = user.email;
                        
                        // Verificar se √© admin e mostrar se√ß√µes espec√≠ficas
                        if (user.role === 'admin') {
                            console.log('üëë [CONFIG] Usu√°rio √© admin, mostrando se√ß√µes espec√≠ficas...');
                            
                            const adminCard = document.getElementById('admin-register-card');
                            if (adminCard) {
                                adminCard.style.display = 'block';
                                console.log('‚úÖ [CONFIG] Card de registro admin exibido');
                            } else {
                                console.error('‚ùå [CONFIG] Card de registro admin n√£o encontrado!');
                            }
                            
                            const adminUsersSection = document.getElementById('admin-users-section');
                            if (adminUsersSection) {
                                adminUsersSection.style.display = 'block';
                                console.log('‚úÖ [CONFIG] Se√ß√£o de gerenciamento de usu√°rios exibida');
                                loadUsers(); // Carregar usu√°rios apenas se for admin
                            } else {
                                console.error('‚ùå [CONFIG] Se√ß√£o de gerenciamento de usu√°rios n√£o encontrada!');
                            }
                            
                            const adminFamiliesCard = document.getElementById('admin-families-card');
                            if (adminFamiliesCard) {
                                adminFamiliesCard.style.display = 'block';
                                console.log('‚úÖ [CONFIG] Card de gerenciamento de fam√≠lias exibido');
                                loadFamilies(); // Carregar fam√≠lias apenas se for admin
                                setupFamilyForm(); // Configurar formul√°rio apenas se for admin
                                loadFamiliesForSelect(); // Carregar fam√≠lias para selects apenas se for admin
                            } else {
                                console.error('‚ùå [CONFIG] Card de gerenciamento de fam√≠lias n√£o encontrado!');
                            }
                        } else {
                            console.log('üë§ [CONFIG] Usu√°rio n√£o √© admin, ocultando se√ß√µes espec√≠ficas');
                        }
                    } else {
                        console.error('‚ùå [CONFIG] Estrutura de dados inv√°lida:', data);
                        throw new Error('Estrutura de dados inv√°lida');
                    }
                } else {
                    console.error('‚ùå [CONFIG] Erro na resposta do perfil:', response.status);
                    throw new Error('Erro ao carregar perfil');
                }
            } catch (error) {
                console.error('üí• [CONFIG] Erro ao carregar perfil:', error);
                showToast('Erro', 'Erro ao carregar perfil do usu√°rio', 'error');
            }
        }

        // Preparar formul√°rio de registro admin
        function setupAdminRegisterIfAllowed() {
            console.log('üîß [CONFIG] Configurando formul√°rio de registro admin...');
            const form = document.getElementById('admin-register-form');
            if (!form) {
                console.error('‚ùå [CONFIG] Formul√°rio admin-register-form n√£o encontrado!');
                return;
            }
            console.log('‚úÖ [CONFIG] Formul√°rio encontrado, adicionando event listener...');
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('üìù [CONFIG] Submiss√£o do formul√°rio iniciada...');
                
                const name = document.getElementById('admin-register-name').value.trim();
                const email = document.getElementById('admin-register-email').value.trim();
                const password = document.getElementById('admin-register-password').value;
                const role = document.getElementById('admin-register-role').value;
                const familyId = document.getElementById('admin-register-family').value;
                
                console.log('üìã [CONFIG] Dados do formul√°rio:', { name, email, role, passwordLength: password.length, familyId });
                
                if (!name || !email || !password) {
                    console.log('‚ùå [CONFIG] Campos obrigat√≥rios n√£o preenchidos');
                    showToast('Erro', 'Preencha todos os campos', 'error');
                    return;
                }
                if (password.length < 6) {
                    console.log('‚ùå [CONFIG] Senha muito curta');
                    showToast('Erro', 'A senha deve ter pelo menos 6 caracteres', 'error');
                    return;
                }
                
                const button = form.querySelector('button[type="submit"]');
                const spinner = button.querySelector('.loading-spinner');
                const buttonText = button.querySelector('.button-text');
                
                try {
                    console.log('üîÑ [CONFIG] Iniciando cria√ß√£o do usu√°rio...');
                    spinner.classList.remove('hidden');
                    button.disabled = true;
                    buttonText.textContent = 'Criando...';
                    
                    const token = localStorage.getItem('token');
                    console.log('üîë [CONFIG] Token encontrado:', !!token);
                    
                    const body = { name, email, password, role };
                    if (familyId) {
                        body.familyId = familyId;
                    }
                    
                    const resp = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(body)
                    });
                    
                    console.log('üì° [CONFIG] Resposta da API:', resp.status, resp.statusText);
                    const result = await resp.json();
                    console.log('üìÑ [CONFIG] Resultado da API:', result);
                    
                    if (resp.ok && result.success) {
                        console.log('‚úÖ [CONFIG] Usu√°rio criado com sucesso!');
                        showToast('Sucesso', 'Usu√°rio criado com sucesso', 'success');
                        form.reset();
                        loadUsers(); // Recarregar lista de usu√°rios
                    } else {
                        console.log('‚ùå [CONFIG] Erro na cria√ß√£o:', result.message);
                        showToast('Erro', result.message || 'Erro ao criar usu√°rio', 'error');
                    }
                } catch (err) {
                    console.error('üí• [CONFIG] Erro na cria√ß√£o:', err);
                    showToast('Erro', 'Falha na comunica√ß√£o com o servidor', 'error');
                } finally {
                    spinner.classList.add('hidden');
                    button.disabled = false;
                    buttonText.textContent = 'Criar Usu√°rio';
                }
            });
            console.log('‚úÖ [CONFIG] Event listener adicionado com sucesso!');
            
            // Carregar fam√≠lias para o select
            loadFamiliesForSelect();
        }

        // Carregar estat√≠sticas
        async function loadStats() {
            try {
                console.log('üìä [CONFIG] Carregando estat√≠sticas...');
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('‚ùå [CONFIG] Token n√£o encontrado para carregar estat√≠sticas');
                    return;
                }
                
                const response = await fetch('/api/kids', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('üì° [CONFIG] Resposta da API de crian√ßas:', response.status, response.statusText);

                if (response.ok) {
                    const kidsData = await response.json();
                    console.log('üìÑ [CONFIG] Dados das crian√ßas:', kidsData);
                    const totalKids = kidsData.success && kidsData.data && kidsData.data.kids ? kidsData.data.kids.length : 0;
                    console.log('üë∂ [CONFIG] Total de crian√ßas:', totalKids);
                    document.getElementById('total-kids').textContent = totalKids;

                    // Carregar atividades
                    console.log('üéØ [CONFIG] Carregando atividades...');
                    const activitiesResponse = await fetch('/api/activities', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    console.log('üì° [CONFIG] Resposta da API de atividades:', activitiesResponse.status, activitiesResponse.statusText);

                    if (activitiesResponse.ok) {
                        const activitiesData = await activitiesResponse.json();
                        console.log('üìÑ [CONFIG] Dados das atividades:', activitiesData);
                        const totalActivities = activitiesData.success && activitiesData.data && activitiesData.data.activities ? activitiesData.data.activities.length : 0;
                        console.log('üéØ [CONFIG] Total de atividades:', totalActivities);
                        document.getElementById('total-activities').textContent = totalActivities;
                    }

                    // Carregar pontos
                    console.log('‚≠ê [CONFIG] Carregando pontos...');
                    const pointsResponse = await fetch('/api/points/history', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    console.log('üì° [CONFIG] Resposta da API de pontos:', pointsResponse.status, pointsResponse.statusText);

                    if (pointsResponse.ok) {
                        const pointsData = await pointsResponse.json();
                        console.log('üìÑ [CONFIG] Dados dos pontos:', pointsData);
                        if (pointsData.success && pointsData.data && pointsData.data.history) {
                            const totalRecords = pointsData.data.history.length;
                            console.log('üìù [CONFIG] Total de registros:', totalRecords);
                            document.getElementById('total-records').textContent = totalRecords;

                            // Calcular total de pontos
                            let totalPointsValue = 0;
                            pointsData.data.history.forEach(point => {
                                if (point.type === 'add') {
                                    totalPointsValue += point.points;
                                } else {
                                    totalPointsValue -= point.points;
                                }
                            });
                            console.log('‚≠ê [CONFIG] Total de pontos:', totalPointsValue);
                            document.getElementById('total-points').textContent = totalPointsValue;
                        } else {
                            console.log('üìù [CONFIG] Nenhum hist√≥rico de pontos encontrado');
                            document.getElementById('total-records').textContent = '0';
                            document.getElementById('total-points').textContent = '0';
                        }
                    }
                    
                    console.log('‚úÖ [CONFIG] Estat√≠sticas carregadas com sucesso!');
                } else {
                    console.error('‚ùå [CONFIG] Erro na resposta da API de crian√ßas:', response.status);
                }
            } catch (error) {
                console.error('üí• [CONFIG] Erro ao carregar estat√≠sticas:', error);
                // Definir valores padr√£o em caso de erro
                document.getElementById('total-kids').textContent = '0';
                document.getElementById('total-activities').textContent = '0';
                document.getElementById('total-records').textContent = '0';
                document.getElementById('total-points').textContent = '0';
            }
        }

        // Popular select de meses
        function populateMonthSelect() {
            console.log('üìÖ [CONFIG] Populando select de meses...');
            const select = document.getElementById('history-month');
            if (!select) {
                console.error('‚ùå [CONFIG] Select de meses n√£o encontrado!');
                return;
            }
            
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            
            select.innerHTML = '<option value="">Selecione um m√™s</option>';
            console.log('üìÖ [CONFIG] Ano atual:', currentYear);
            
            // √öltimos 12 meses
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentYear, currentDate.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const monthName = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                const option = document.createElement('option');
                option.value = `${year}-${month}`;
                option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                select.appendChild(option);
                console.log(`üìÖ [CONFIG] M√™s adicionado: ${option.value} - ${option.textContent}`);
            }
            
            console.log('‚úÖ [CONFIG] Select de meses populado com sucesso!');
        }

        // Popular select de crian√ßas
        async function populateKidsSelect() {
            try {
                console.log('üë∂ [CONFIG] Populando select de crian√ßas...');
                const select = document.getElementById('history-kid');
                if (!select) {
                    console.error('‚ùå [CONFIG] Select de crian√ßas n√£o encontrado!');
                    return;
                }
                
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('‚ùå [CONFIG] Token n√£o encontrado para carregar crian√ßas');
                    return;
                }
                
                const response = await fetch('/api/kids', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('üì° [CONFIG] Resposta da API de crian√ßas:', response.status, response.statusText);

                if (response.ok) {
                    const kidsData = await response.json();
                    console.log('üìÑ [CONFIG] Dados das crian√ßas:', kidsData);
                    
                    select.innerHTML = '<option value="">Todas as crian√ßas</option>';
                    
                    if (kidsData.success && kidsData.data && kidsData.data.kids) {
                        kidsData.data.kids.forEach(kid => {
                            console.log(`üë∂ [CONFIG] Adicionando crian√ßa: ${kid.name}`);
                            const option = document.createElement('option');
                            option.value = kid._id;
                            option.textContent = kid.name;
                            select.appendChild(option);
                        });
                        console.log(`‚úÖ [CONFIG] ${kidsData.data.kids.length} crian√ßas adicionadas ao select`);
                    } else {
                        console.log('üìù [CONFIG] Nenhuma crian√ßa encontrada');
                    }
                } else {
                    console.error('‚ùå [CONFIG] Erro na resposta da API de crian√ßas:', response.status);
                }
            } catch (error) {
                console.error('üí• [CONFIG] Erro ao popular select de crian√ßas:', error);
            }
        }

        // Alterar senha
        document.getElementById('change-password-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            
            if (newPassword !== confirmPassword) {
                showToast('Erro', 'As senhas n√£o coincidem', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('Erro', 'A nova senha deve ter pelo menos 6 caracteres', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/auth/change-password', {
                    method: 'PUT', // Corrigido de POST para PUT
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('Sucesso', 'Senha alterada com sucesso!', 'success');
                    document.getElementById('change-password-form').reset();
                } else {
                    showToast('Erro', data.message || 'Erro ao alterar senha', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro', 'Erro ao alterar senha', 'error');
            }
        });

        // Confirmar exclus√£o de pontos
        function confirmDeletePoints() {
            showConfirmModal(
                'Apagar Todos os Pontos',
                'Tem certeza que deseja apagar TODOS os pontos de TODAS as crian√ßas? Esta a√ß√£o n√£o pode ser desfeita!',
                deleteAllPoints
            );
        }

        // Apagar todos os pontos
        async function deleteAllPoints() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/points/delete-all', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('Sucesso', data.message, 'success');
                    loadStats(); // Recarregar estat√≠sticas
                } else {
                    showToast('Erro', data.message || 'Erro ao apagar pontos', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro', 'Erro ao apagar pontos', 'error');
            }
        }

        // Confirmar exclus√£o de hist√≥rico
        function confirmDeleteHistory() {
            showConfirmModal(
                'Apagar Hist√≥rico Completo',
                'Tem certeza que deseja apagar TODO o hist√≥rico de pontos? Esta a√ß√£o n√£o pode ser desfeita!',
                deleteAllHistory
            );
        }

        // Apagar todo o hist√≥rico
        async function deleteAllHistory() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/points/delete-history', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('Sucesso', data.message, 'success');
                    loadStats(); // Recarregar estat√≠sticas
                } else {
                    showToast('Erro', data.message || 'Erro ao apagar hist√≥rico', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro', 'Erro ao apagar hist√≥rico', 'error');
            }
        }

        // Baixar hist√≥rico em PDF
        async function downloadHistoryPDF() {
            console.log('üì• [CONFIG] Iniciando download do hist√≥rico em PDF...');
            const month = document.getElementById('history-month').value;
            const kidId = document.getElementById('history-kid').value;
            
            console.log('üìã [CONFIG] Par√¢metros:', { month, kidId });
            
            if (!month) {
                console.log('‚ùå [CONFIG] M√™s n√£o selecionado');
                showToast('Erro', 'Selecione um m√™s para baixar o hist√≥rico', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('‚ùå [CONFIG] Token n√£o encontrado');
                    showToast('Erro', 'Token de autentica√ß√£o n√£o encontrado', 'error');
                    return;
                }
                
                let url = `/api/points/history-by-month?month=${month}`;
                if (kidId) {
                    url += `&kidId=${kidId}`;
                }
                
                console.log('üì° [CONFIG] URL da requisi√ß√£o:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('üì° [CONFIG] Resposta da API:', response.status, response.statusText);
                const data = await response.json();
                console.log('üìÑ [CONFIG] Dados recebidos:', data);
                
                if (response.ok) {
                    console.log('‚úÖ [CONFIG] Dados recebidos com sucesso, gerando PDF...');
                    generateHistoryPDF(data.data, kidId);
                } else {
                    console.log('‚ùå [CONFIG] Erro na resposta da API:', data.message);
                    showToast('Erro', data.message || 'Erro ao baixar hist√≥rico', 'error');
                }
            } catch (error) {
                console.error('üí• [CONFIG] Erro ao baixar hist√≥rico:', error);
                showToast('Erro', 'Erro ao baixar hist√≥rico', 'error');
            }
        }

        // Baixar atividades em PDF
        async function downloadActivitiesPDF() {
            try {
                console.log('üì• [CONFIG] Iniciando download das atividades em PDF...');
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('‚ùå [CONFIG] Token n√£o encontrado');
                    showToast('Erro', 'Token de autentica√ß√£o n√£o encontrado', 'error');
                    return;
                }
                
                console.log('üì° [CONFIG] Fazendo requisi√ß√£o para /api/activities...');
                const response = await fetch('/api/activities', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('üì° [CONFIG] Resposta da API de atividades:', response.status, response.statusText);
                const data = await response.json();
                console.log('üìÑ [CONFIG] Dados das atividades:', data);
                
                if (response.ok && data.success && data.data && data.data.activities) {
                    const filterType = document.getElementById('activities-filter').value;
                    console.log('üîç [CONFIG] Filtro aplicado:', filterType);
                    console.log('‚úÖ [CONFIG] Dados recebidos com sucesso, gerando PDF...');
                    generateActivitiesPDF(data.data.activities, filterType);
                } else {
                    console.log('‚ùå [CONFIG] Erro na resposta da API:', data.message);
                    showToast('Erro', data.message || 'Erro ao baixar atividades', 'error');
                }
            } catch (error) {
                console.error('üí• [CONFIG] Erro ao baixar atividades:', error);
                showToast('Erro', 'Erro ao baixar atividades', 'error');
            }
        }

        // Gerar PDF do hist√≥rico
        function generateHistoryPDF(data, kidId) {
            try {
                console.log('üìÑ [CONFIG] Gerando PDF do hist√≥rico...');
                console.log('üìã [CONFIG] Dados recebidos:', data);
                console.log('üë∂ [CONFIG] ID da crian√ßa:', kidId);
                
                if (!window.jspdf) {
                    console.error('‚ùå [CONFIG] Biblioteca jsPDF n√£o encontrada!');
                    showToast('Erro', 'Biblioteca PDF n√£o dispon√≠vel', 'error');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                console.log('‚úÖ [CONFIG] Documento PDF criado');
                
                // T√≠tulo
                doc.setFontSize(20);
                doc.text('Hist√≥rico de Pontos', 20, 20);
                
                doc.setFontSize(12);
                doc.text(`M√™s: ${data.month}`, 20, 30);
                doc.text(`Per√≠odo: ${new Date(data.startDate).toLocaleDateString('pt-BR')} a ${new Date(data.endDate).toLocaleDateString('pt-BR')}`, 20, 40);
                
                if (data.history.length === 0) {
                    console.log('üìù [CONFIG] Nenhum registro encontrado para este m√™s');
                    doc.text('Nenhum registro encontrado para este m√™s.', 20, 60);
                } else {
                    console.log(`üìù [CONFIG] Processando ${data.history.length} registros...`);
                    // Agrupar por crian√ßa
                    const kidsData = {};
                    data.history.forEach(point => {
                        const kidName = point.kidId.name;
                        if (!kidsData[kidName]) {
                            kidsData[kidName] = [];
                        }
                        kidsData[kidName].push(point);
                    });
                    
                    console.log(`üë∂ [CONFIG] Dados agrupados por ${Object.keys(kidsData).length} crian√ßas`);
                    
                    let yPosition = 60;
                    
                    Object.keys(kidsData).forEach(kidName => {
                        const points = kidsData[kidName];
                        console.log(`üë∂ [CONFIG] Processando crian√ßa: ${kidName} com ${points.length} registros`);
                        
                        // Ordenar pontos por data (do in√≠cio para o fim do m√™s)
                        points.sort((a, b) => new Date(a.date) - new Date(b.date));
                        console.log(`üìÖ [CONFIG] Pontos ordenados cronologicamente para ${kidName}`);
                        
                        // Nome da crian√ßa
                        doc.setFontSize(14);
                        doc.setFont(undefined, 'bold');
                        doc.text(`Crian√ßa: ${kidName}`, 20, yPosition);
                        yPosition += 10;
                        
                        // Tabela de pontos
                        const tableData = points.map(point => [
                            new Date(point.date).toLocaleDateString('pt-BR'),
                            point.activityId ? point.activityId.name : 'Pontos avulsos',
                            point.type === 'add' ? `+${point.points}` : `-${point.points}`,
                            point.notes || '-'
                        ]);
                        
                        console.log(`üìä [CONFIG] Gerando tabela para ${kidName} com ${tableData.length} linhas`);
                        
                        doc.autoTable({
                            startY: yPosition,
                            head: [['Data', 'Atividade', 'Pontos', 'Observa√ß√µes']],
                            body: tableData,
                            theme: 'grid',
                            headStyles: { fillColor: [66, 139, 202] }
                        });
                        
                        yPosition = doc.lastAutoTable.finalY + 15;
                        
                        // Calcular total da crian√ßa
                        const total = points.reduce((sum, point) => {
                            return sum + (point.type === 'add' ? point.points : -point.points);
                        }, 0);
                        
                        console.log(`‚≠ê [CONFIG] Total da crian√ßa ${kidName}: ${total} pontos`);
                        
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text(`Total da crian√ßa: ${total} pontos`, 20, yPosition);
                        yPosition += 20;
                    });
                }
                
                // Salvar PDF
                let fileName = `historico_pontos_${data.month}`;
                if (kidId) {
                    const selectedKid = document.getElementById('history-kid').options[document.getElementById('history-kid').selectedIndex].text;
                    fileName += `_${selectedKid.split(' ')[0]}`; // Adiciona o nome da crian√ßa ao arquivo
                }
                fileName += '.pdf';
                
                console.log('üíæ [CONFIG] Salvando PDF com nome:', fileName);
                doc.save(fileName);
                showToast('Sucesso', 'PDF do hist√≥rico baixado com sucesso!', 'success');
                console.log('‚úÖ [CONFIG] PDF gerado e salvo com sucesso!');
            } catch (error) {
                console.error('üí• [CONFIG] Erro ao gerar PDF do hist√≥rico:', error);
                showToast('Erro', 'Erro ao gerar PDF do hist√≥rico', 'error');
            }
        }

                 // Gerar PDF das atividades
         function generateActivitiesPDF(activities, filterType = 'all') {
             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();
             
             // T√≠tulo
             doc.setFontSize(20);
             doc.text('Relat√≥rio de Atividades', 20, 20);
             doc.setFontSize(12);
             doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 30);
             
             // Filtrar atividades baseado no tipo selecionado
             let filteredActivities = activities;
             let filterText = 'Todas as atividades';
             
             if (filterType === 'positive') {
                 filteredActivities = activities.filter(activity => activity.type === 'positive');
                 filterText = 'Apenas atividades positivas';
             } else if (filterType === 'negative') {
                 filteredActivities = activities.filter(activity => activity.type === 'negative');
                 filterText = 'Apenas atividades negativas';
             }
             
             doc.text(`Filtro: ${filterText}`, 20, 40);
             
             if (filteredActivities.length === 0) {
                 doc.text('Nenhuma atividade encontrada com o filtro selecionado.', 20, 60);
             } else {
                 // Ordenar alfabeticamente
                 filteredActivities.sort((a, b) => a.name.localeCompare(b.name));
                 
                 let yPosition = 60;
                 
                 // Se mostrar todas ou apenas positivas
                 if (filterType === 'all' || filterType === 'positive') {
                     const positiveActivities = filteredActivities.filter(activity => activity.type === 'positive');
                     if (positiveActivities.length > 0) {
                         doc.setFontSize(14);
                         doc.setFont(undefined, 'bold');
                         doc.text('Atividades Positivas', 20, yPosition);
                         yPosition += 10;
                         
                         const positiveData = positiveActivities.map(activity => [
                             activity.name,
                             activity.points,
                             activity.description || '-'
                         ]);
                         
                         doc.autoTable({
                             startY: yPosition,
                             head: [['Atividade', 'Pontos', 'Descri√ß√£o']],
                             body: positiveData,
                             theme: 'grid',
                             headStyles: { fillColor: [40, 167, 69] }
                         });
                         
                         yPosition = doc.lastAutoTable.finalY + 20;
                     }
                 }
                 
                 // Se mostrar todas ou apenas negativas
                 if (filterType === 'all' || filterType === 'negative') {
                     const negativeActivities = filteredActivities.filter(activity => activity.type === 'negative');
                     if (negativeActivities.length > 0) {
                         doc.setFontSize(14);
                         doc.setFont(undefined, 'bold');
                         doc.text('Atividades Negativas', 20, yPosition);
                         yPosition += 10;
                         
                         const negativeData = negativeActivities.map(activity => [
                             activity.name,
                             activity.points,
                             activity.description || '-'
                         ]);
                         
                         doc.autoTable({
                             startY: yPosition,
                             head: [['Atividade', 'Pontos', 'Descri√ß√£o']],
                             body: negativeData,
                             theme: 'grid',
                             headStyles: { fillColor: [220, 53, 69] }
                         });
                     }
                 }
             }
             
             // Salvar PDF
             let fileName = `relatorio_atividades_${new Date().toISOString().split('T')[0]}`;
             if (filterType !== 'all') {
                 fileName += `_${filterType}`;
             }
             fileName += '.pdf';
             doc.save(fileName);
             showToast('Sucesso', 'PDF das atividades baixado com sucesso!', 'success');
         }

        // Fun√ß√µes auxiliares para modais
        function showConfirmModal(title, message, onConfirm) {
            console.log('‚ùì [CONFIG] Mostrando modal de confirma√ß√£o:', { title, message });
            
            const modal = document.getElementById('confirm-modal');
            if (!modal) {
                console.error('‚ùå [CONFIG] Modal de confirma√ß√£o n√£o encontrado!');
                // Fallback para alert nativo
                if (confirm(`${title}\n\n${message}`)) {
                    onConfirm();
                }
                return;
            }
            
            // Configurar modal
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            // Configurar bot√£o de confirma√ß√£o
            const confirmBtn = document.getElementById('modal-confirm-btn');
            confirmBtn.onclick = () => {
                console.log('‚úÖ [CONFIG] Confirma√ß√£o aceita, executando a√ß√£o...');
                onConfirm();
                closeModal('confirm-modal');
            };
            
            modal.classList.remove('hidden');
            console.log('‚úÖ [CONFIG] Modal de confirma√ß√£o exibido');
        }

        function showToast(title, message, type = 'info') {
            // Usar o sistema de toast global se dispon√≠vel
            if (window.toastSystem) {
                window.toastSystem.show({ title, message, type });
                return;
            }
            
            // Fallback para implementa√ß√£o local
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                // Create a container if it doesn't exist
                const newToastContainer = document.createElement('div');
                newToastContainer.id = 'toast-container';
                newToastContainer.style.position = 'fixed';
                newToastContainer.style.top = '20px';
                newToastContainer.style.right = '20px';
                newToastContainer.style.zIndex = '10000';
                document.body.appendChild(newToastContainer);
            }

            const toast = document.createElement('div');
            toast.classList.add('toast', `toast-${type}`);
            toast.innerHTML = `
                <div class="toast-header">
                    <strong>${title}</strong>
                    <button class="toast-close-button" onclick="closeToast(this.parentElement)">&times;</button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            document.getElementById('toast-container').appendChild(toast);

            // Automatically remove the toast after 5 seconds
            setTimeout(() => {
                closeToast(toast);
            }, 5000);
        }

        function closeToast(toast) {
            toast.classList.remove('show');
            toast.classList.add('hide');
            setTimeout(() => {
                toast.remove();
            }, 300); // Remove after transition
        }

        function closeModal(modalId) {
            console.log('üö™ [CONFIG] Fechando modal:', modalId);
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                console.log('‚úÖ [CONFIG] Modal fechado:', modalId);
            } else {
                console.error('‚ùå [CONFIG] Modal n√£o encontrado:', modalId);
            }
        }

        // Fun√ß√µes para gerenciamento de usu√°rios (Admin)
        async function loadUsers() {
            try {
                console.log('üë• [CONFIG] Carregando lista de usu√°rios...');
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('‚ùå [CONFIG] Token n√£o encontrado');
                    return;
                }

                const response = await fetch('/api/auth/users', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('üì° [CONFIG] Resposta da API de usu√°rios:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìÑ [CONFIG] Dados dos usu√°rios:', data);
                
                if (data.success && data.data && data.data.users) {
                    const tbody = document.getElementById('users-table-body');
                    if (!tbody) {
                        console.error('‚ùå [CONFIG] Elemento users-table-body n√£o encontrado');
                        return;
                    }
                    
                    console.log(`‚úÖ [CONFIG] Carregando ${data.data.users.length} usu√°rios...`);
                    tbody.innerHTML = ''; // Limpar tabela antes de adicionar
                    
                    data.data.users.forEach((user, index) => {
                        console.log(`üë§ [CONFIG] Processando usu√°rio ${index + 1}:`, { 
                            name: user.name, 
                            email: user.email, 
                            role: user.role,
                            familyId: user.familyId,
                            familyIdType: typeof user.familyId,
                            familyIdName: user.familyId?.name
                        });
                        
                        // Verificar se o familyId existe e tem nome
                        let familyName = 'Sem fam√≠lia';
                        let familyIdValue = '';
                        
                        if (user.familyId) {
                            if (typeof user.familyId === 'object' && user.familyId.name) {
                                // familyId foi populado corretamente
                                familyName = user.familyId.name;
                                familyIdValue = user.familyId._id || '';
                                console.log(`üè† [CONFIG] Fam√≠lia populada para ${user.name}: ${familyName}`);
                            } else if (typeof user.familyId === 'string') {
                                // familyId √© apenas o ID (n√£o foi populado)
                                familyName = 'Fam√≠lia Azevedo'; // Assumir que √© a Fam√≠lia Azevedo
                                familyIdValue = user.familyId;
                                console.log(`üè† [CONFIG] Fam√≠lia n√£o populada para ${user.name}, assumindo Fam√≠lia Azevedo`);
                            } else if (user.familyId && user.familyId._id) {
                                // familyId √© um objeto com _id mas sem name (pode ser populado parcialmente)
                                familyName = 'Fam√≠lia Azevedo'; // Assumir que √© a Fam√≠lia Azevedo
                                familyIdValue = user.familyId._id;
                                console.log(`üè† [CONFIG] Fam√≠lia parcialmente populada para ${user.name}, assumindo Fam√≠lia Azevedo`);
                            }
                        }
                        
                        console.log(`üè† [CONFIG] Fam√≠lia final para ${user.name}:`, { familyName, familyIdValue });
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.name || ''}</td>
                            <td>${user.email || ''}</td>
                            <td>${user.role === 'admin' ? 'Administrador' : 'Pai/M√£e'}</td>
                            <td><span class="status-badge ${user.isActive ? 'active' : 'inactive'}">${user.isActive ? 'Ativo' : 'Inativo'}</span></td>
                            <td>${familyName}</td>
                            <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('pt-BR') : '-'}</td>
                            <td>
                                <button onclick="showEditUserModal('${user._id}', '${user.name || ''}', '${user.email || ''}', '${user.role || 'parent'}', ${user.isActive || false}, '${familyIdValue}')" class="btn btn-sm btn-info">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="showDeleteUserModal('${user._id}', '${user.name || ''}')" class="btn btn-sm btn-danger">
                                    üóëÔ∏è Excluir
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    console.log('‚úÖ [CONFIG] Lista de usu√°rios carregada com sucesso!');
                } else {
                    console.error('‚ùå [CONFIG] Erro ao carregar usu√°rios:', data.message);
                    showToast('Erro', data.message || 'Erro ao carregar usu√°rios', 'error');
                }
            } catch (error) {
                console.error('üí• [CONFIG] Erro ao carregar usu√°rios:', error);
                showToast('Erro', 'Erro ao carregar usu√°rios', 'error');
            }
        }

        function showAddUserModal() {
            console.log('‚ûï [CONFIG] Mostrando modal para adicionar usu√°rio...');
            
            const modal = document.getElementById('user-modal');
            if (!modal) {
                console.error('‚ùå [CONFIG] Modal de adicionar usu√°rio n√£o encontrado!');
                showToast('Erro', 'Modal de adicionar usu√°rio n√£o dispon√≠vel', 'error');
                return;
            }
            
            // Limpar campos e remover ID de edi√ß√£o
            modal.removeAttribute('data-user-id');
            document.getElementById('user-form').reset();
            document.getElementById('user-password').required = true;
            document.getElementById('user-password').placeholder = 'Digite a senha';
            
            // Configurar t√≠tulo e bot√£o
            document.getElementById('user-modal-title').textContent = 'Adicionar Novo Usu√°rio';
            const saveButton = modal.querySelector('button[onclick="saveUser()"]');
            if (saveButton) {
                const buttonText = saveButton.querySelector('.button-text');
                if (buttonText) buttonText.textContent = 'Adicionar Usu√°rio';
            }
            
            modal.classList.remove('hidden');
            console.log('‚úÖ [CONFIG] Modal de adicionar usu√°rio exibido');
        }

        function showEditUserModal(userId, name, email, role, isActive, familyId) {
            console.log('‚úèÔ∏è [CONFIG] Mostrando modal de edi√ß√£o para usu√°rio:', { userId, name, email, role, isActive, familyId });
            
            const modal = document.getElementById('user-modal');
            if (!modal) {
                console.error('‚ùå [CONFIG] Modal de adicionar/editar n√£o encontrado!');
                showToast('Erro', 'Modal de adicionar/editar n√£o dispon√≠vel', 'error');
                return;
            }
            
            // Preencher campos do modal
            document.getElementById('user-name').value = name || '';
            document.getElementById('user-email').value = email || '';
            document.getElementById('user-role').value = role || 'parent';
            document.getElementById('user-status').value = isActive ? 'true' : 'false';
            document.getElementById('user-password').required = false;
            document.getElementById('user-password').placeholder = 'Deixe em branco para manter a senha atual';
            
            // Preencher fam√≠lia (se o select existir)
            const familySelect = document.getElementById('user-family');
            if (familySelect) {
                // Primeiro carregar as fam√≠lias se ainda n√£o foram carregadas
                loadFamiliesForSelect().then(() => {
                    console.log('üè† [CONFIG] Fam√≠lias carregadas, definindo valor:', familyId);
                    familySelect.value = familyId || '';
                }).catch(error => {
                    console.error('‚ùå [CONFIG] Erro ao carregar fam√≠lias:', error);
                    familySelect.value = familyId || '';
                });
            }
            
            // Configurar t√≠tulo e bot√£o
            document.getElementById('user-modal-title').textContent = 'Editar Usu√°rio';
            const saveButton = modal.querySelector('button[onclick="saveUser()"]');
            if (saveButton) {
                const buttonText = saveButton.querySelector('.button-text');
                if (buttonText) buttonText.textContent = 'Salvar';
            }
            
            modal.setAttribute('data-user-id', userId); // Adicionar ID ao modal
            modal.classList.remove('hidden');
            console.log('‚úÖ [CONFIG] Modal de edi√ß√£o exibido com dados preenchidos');
        }

        async function saveUser() {
            try {
                console.log('üíæ [CONFIG] Salvando usu√°rio...');
                const modal = document.getElementById('user-modal');
                const userId = modal.getAttribute('data-user-id');
                const isEdit = !!userId;
                
                console.log('üìù [CONFIG] Modo:', isEdit ? 'Edi√ß√£o' : 'Cria√ß√£o', 'ID:', userId);
                
                const name = document.getElementById('user-name').value.trim();
                const email = document.getElementById('user-email').value.trim();
                const password = document.getElementById('user-password').value;
                const role = document.getElementById('user-role').value;
                const isActive = document.getElementById('user-status').value === 'true';
                const familyId = document.getElementById('user-family') ? document.getElementById('user-family').value : '';
                
                console.log('üìã [CONFIG] Dados para salvar:', { name, email, role, isActive, hasPassword: !!password, familyId });
                
                if (!name || !email) {
                    console.log('‚ùå [CONFIG] Campos obrigat√≥rios n√£o preenchidos');
                    showToast('Erro', 'Nome e email s√£o obrigat√≥rios', 'error');
                    return;
                }
                
                if (!familyId || familyId === '') {
                    console.log('‚ùå [CONFIG] Fam√≠lia n√£o selecionada');
                    showToast('Erro', 'Fam√≠lia √© obrigat√≥ria para todos os usu√°rios', 'error');
                    return;
                }
                
                if (!isEdit && (!password || password.length < 6)) {
                    console.log('‚ùå [CONFIG] Senha inv√°lida para novo usu√°rio');
                    showToast('Erro', 'A senha deve ter pelo menos 6 caracteres', 'error');
                    return;
                }
                
                const button = modal.querySelector('button[onclick="saveUser()"]');
                const spinner = button.querySelector('.loading-spinner');
                const buttonText = button.querySelector('.button-text');
                
                try {
                    console.log('üîÑ [CONFIG] Iniciando opera√ß√£o...');
                    spinner.classList.remove('hidden');
                    button.disabled = true;
                    buttonText.textContent = isEdit ? 'Salvando...' : 'Criando...';
                    
                    const token = localStorage.getItem('token');
                    const url = isEdit ? `/api/auth/users/${userId}` : '/api/auth/register';
                    const method = isEdit ? 'PUT' : 'POST';
                    
                    const body = { name, email, role, isActive, familyId };
                    if (password && password.length > 0) body.password = password;
                    
                    console.log('üì§ [CONFIG] Enviando requisi√ß√£o:', { url, method, body });
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(body)
                    });
                    
                    console.log('üì° [CONFIG] Resposta da API:', response.status, response.statusText);
                    const result = await response.json();
                    console.log('üìÑ [CONFIG] Resultado da API:', result);
                    
                    if (response.ok && result.success) {
                        console.log('‚úÖ [CONFIG] Opera√ß√£o realizada com sucesso!');
                        showToast('Sucesso', result.message || (isEdit ? 'Usu√°rio atualizado com sucesso!' : 'Usu√°rio criado com sucesso!'), 'success');
                        modal.classList.add('hidden');
                        modal.removeAttribute('data-user-id');
                        loadUsers(); // Recarregar lista
                    } else {
                        console.log('‚ùå [CONFIG] Erro na opera√ß√£o:', result.message);
                        showToast('Erro', result.message || (isEdit ? 'Erro ao atualizar usu√°rio' : 'Erro ao criar usu√°rio'), 'error');
                    }
                } catch (err) {
                    console.error('üí• [CONFIG] Erro na comunica√ß√£o:', err);
                    showToast('Erro', 'Falha na comunica√ß√£o com o servidor', 'error');
                } finally {
                    spinner.classList.add('hidden');
                    button.disabled = false;
                    buttonText.textContent = isEdit ? 'Salvar' : 'Adicionar Usu√°rio';
                }
            } catch (error) {
                console.error('üí• [CONFIG] Erro geral ao salvar usu√°rio:', error);
                showToast('Erro', 'Erro inesperado ao salvar usu√°rio', 'error');
            }
        }

        function showDeleteUserModal(userId, userName) {
            console.log('üóëÔ∏è [CONFIG] Mostrando modal de exclus√£o para usu√°rio:', { userId, userName });
            
            // Usar o modal espec√≠fico para exclus√£o de usu√°rios
            const modal = document.getElementById('delete-user-modal');
            if (modal) {
                document.getElementById('delete-user-name').textContent = userName;
                modal.setAttribute('data-user-id', userId); // Adicionar ID ao modal
                modal.classList.remove('hidden');
                console.log('‚úÖ [CONFIG] Modal de exclus√£o de usu√°rio exibido');
            } else {
                console.error('‚ùå [CONFIG] Modal de exclus√£o de usu√°rio n√£o encontrado!');
                // Fallback para modal gen√©rico
                showConfirmModal(
                    'Confirmar Exclus√£o',
                    `Tem certeza que deseja excluir o usu√°rio ${userName}?`,
                    () => deleteUser(userId)
                );
            }
        }

        async function confirmDeleteUser() {
            const modal = document.getElementById('delete-user-modal');
            const userId = modal.getAttribute('data-user-id');
            if (userId) {
                deleteUser(userId);
                closeModal('delete-user-modal');
            } else {
                console.error('‚ùå [CONFIG] ID do usu√°rio n√£o encontrado no modal');
                showToast('Erro', 'Erro ao identificar usu√°rio para exclus√£o', 'error');
            }
        }

        async function deleteUser(userId) {
            try {
                console.log('üóëÔ∏è [CONFIG] Excluindo usu√°rio:', userId);
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/auth/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                console.log('üì° [CONFIG] Resposta da exclus√£o:', response.status, result);
                
                if (response.ok && result.success) {
                    showToast('Sucesso', result.message || 'Usu√°rio exclu√≠do com sucesso!', 'success');
                    loadUsers(); // Recarregar lista
                } else {
                    showToast('Erro', result.message || 'Erro ao excluir usu√°rio', 'error');
                }
            } catch (err) {
                console.error('üí• [CONFIG] Erro ao excluir usu√°rio:', err);
                showToast('Erro', 'Falha na comunica√ß√£o com o servidor', 'error');
            }
        }

        // ==================== FUN√á√ïES DE FAM√çLIAS ====================

        // Carregar fam√≠lias
        async function loadFamilies() {
            try {
                console.log('üè† [CONFIG] Carregando lista de fam√≠lias...');
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('‚ùå [CONFIG] Token n√£o encontrado');
                    return;
                }

                const response = await fetch('/api/families', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('üì° [CONFIG] Resposta da API de fam√≠lias:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìÑ [CONFIG] Dados das fam√≠lias:', data);
                
                if (data.success && data.data && data.data.families) {
                    const tbody = document.getElementById('families-table-body');
                    if (!tbody) {
                        console.error('‚ùå [CONFIG] Elemento families-table-body n√£o encontrado');
                        return;
                    }
                    
                    console.log(`‚úÖ [CONFIG] Carregando ${data.data.families.length} fam√≠lias...`);
                    tbody.innerHTML = ''; // Limpar tabela antes de adicionar
                    
                    data.data.families.forEach((family, index) => {
                        console.log(`üè† [CONFIG] Processando fam√≠lia ${index + 1}:`, { name: family.name, description: family.description });
                        
                        const isAdmFamily = family.name === 'Fam√≠lia ADM';
                        const actionsHtml = isAdmFamily ? 
                            `<span class="text-muted">üîí Protegida</span>` :
                            `<button onclick="showEditFamilyModal('${family._id}', '${family.name || ''}', '${family.description || ''}')" class="btn btn-sm btn-info">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="showDeleteFamilyModal('${family._id}', '${family.name || ''}')" class="btn btn-sm btn-danger">
                                üóëÔ∏è Excluir
                            </button>`;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${family.name || ''}</td>
                            <td>${family.description || '-'}</td>
                            <td><span class="badge">${family.memberCount || 0}</span></td>
                            <td><span class="badge">${family.kidCount || 0}</span></td>
                            <td>${family.createdAt ? new Date(family.createdAt).toLocaleDateString('pt-BR') : '-'}</td>
                            <td>${actionsHtml}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    console.log('‚úÖ [CONFIG] Lista de fam√≠lias carregada com sucesso!');
                } else {
                    console.error('‚ùå [CONFIG] Erro ao carregar fam√≠lias:', data.message);
                    showToast('Erro', data.message || 'Erro ao carregar fam√≠lias', 'error');
                }
            } catch (error) {
                console.error('üí• [CONFIG] Erro ao carregar fam√≠lias:', error);
                showToast('Erro', 'Erro ao carregar fam√≠lias', 'error');
            }
        }

        // Configurar formul√°rio de fam√≠lias
        function setupFamilyForm() {
            console.log('üîß [CONFIG] Configurando formul√°rio de fam√≠lias...');
            const form = document.getElementById('family-form');
            if (!form) {
                console.error('‚ùå [CONFIG] Formul√°rio family-form n√£o encontrado!');
                return;
            }
            console.log('‚úÖ [CONFIG] Formul√°rio encontrado, adicionando event listener...');
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('üìù [CONFIG] Submiss√£o do formul√°rio de fam√≠lia iniciada...');
                
                const name = document.getElementById('family-name').value.trim();
                const description = document.getElementById('family-description').value.trim();
                
                console.log('üìã [CONFIG] Dados do formul√°rio:', { name, description });
                
                if (!name) {
                    console.log('‚ùå [CONFIG] Nome da fam√≠lia n√£o preenchido');
                    showToast('Erro', 'Nome da fam√≠lia √© obrigat√≥rio', 'error');
                    return;
                }
                
                const button = form.querySelector('button[type="submit"]');
                const spinner = button.querySelector('.loading-spinner');
                const buttonText = button.querySelector('.button-text');
                
                try {
                    console.log('üîÑ [CONFIG] Iniciando cria√ß√£o da fam√≠lia...');
                    spinner.classList.remove('hidden');
                    button.disabled = true;
                    buttonText.textContent = 'Criando...';
                    
                    const token = localStorage.getItem('token');
                    console.log('üîë [CONFIG] Token encontrado:', !!token);
                    
                    const resp = await fetch('/api/families', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ name, description })
                    });
                    
                    console.log('üì° [CONFIG] Resposta da API:', resp.status, resp.statusText);
                    const result = await resp.json();
                    console.log('üìÑ [CONFIG] Resultado da API:', result);
                    
                    if (resp.ok && result.success) {
                        console.log('‚úÖ [CONFIG] Fam√≠lia criada com sucesso!');
                        showToast('Sucesso', 'Fam√≠lia criada com sucesso', 'success');
                        form.reset();
                        loadFamilies(); // Recarregar lista de fam√≠lias
                        loadFamiliesForSelect(); // Recarregar select de fam√≠lias
                    } else {
                        console.log('‚ùå [CONFIG] Erro na cria√ß√£o:', result.message);
                        showToast('Erro', result.message || 'Erro ao criar fam√≠lia', 'error');
                    }
                } catch (err) {
                    console.error('üí• [CONFIG] Erro na cria√ß√£o:', err);
                    showToast('Erro', 'Falha na comunica√ß√£o com o servidor', 'error');
                } finally {
                    spinner.classList.add('hidden');
                    button.disabled = false;
                    buttonText.textContent = 'Criar Fam√≠lia';
                }
            });
            console.log('‚úÖ [CONFIG] Event listener adicionado com sucesso!');
        }

        // Carregar fam√≠lias para selects
        async function loadFamiliesForSelect() {
            try {
                console.log('üè† [CONFIG] Carregando fam√≠lias para selects...');
                
                const token = localStorage.getItem('token');
                const response = await fetch('/api/families', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                console.log('üìÑ [CONFIG] Dados das fam√≠lias:', data);
                
                if (data.success && data.data && data.data.families) {
                    // Carregar para o select de registro admin
                    const adminSelect = document.getElementById('admin-register-family');
                    if (adminSelect) {
                        adminSelect.innerHTML = '<option value="">Selecione uma fam√≠lia</option>';
                        data.data.families.forEach(family => {
                            const option = document.createElement('option');
                            option.value = family._id;
                            option.textContent = family.name;
                            adminSelect.appendChild(option);
                        });
                        console.log('‚úÖ [CONFIG] Fam√≠lias carregadas no select admin');
                    }
                    
                    // Carregar para o select do modal de usu√°rio
                    const userSelect = document.getElementById('user-family');
                    if (userSelect) {
                        userSelect.innerHTML = '<option value="">Selecione uma fam√≠lia</option>';
                        data.data.families.forEach(family => {
                            const option = document.createElement('option');
                            option.value = family._id;
                            option.textContent = family.name;
                            userSelect.appendChild(option);
                        });
                        console.log('‚úÖ [CONFIG] Fam√≠lias carregadas no select user');
                    }
                    
                    console.log('‚úÖ [CONFIG] Fam√≠lias carregadas nos selects');
                } else {
                    console.error('‚ùå [CONFIG] Estrutura de dados inv√°lida:', data);
                }
            } catch (error) {
                console.error('üí• [CONFIG] Erro ao carregar fam√≠lias para select:', error);
            }
        }

        // Mostrar modal de edi√ß√£o de fam√≠lia
        function showEditFamilyModal(familyId, familyName, familyDescription) {
            console.log('‚úèÔ∏è [CONFIG] Mostrando modal de edi√ß√£o para fam√≠lia:', { familyId, familyName });
            
            const modal = document.getElementById('edit-family-modal');
            if (!modal) {
                console.error('‚ùå [CONFIG] Modal de edi√ß√£o de fam√≠lia n√£o encontrado!');
                showToast('Erro', 'Modal de edi√ß√£o de fam√≠lia n√£o dispon√≠vel', 'error');
                return;
            }
            
            // Preencher campos
            document.getElementById('edit-family-name').value = familyName;
            document.getElementById('edit-family-description').value = familyDescription;
            
            // Configurar t√≠tulo e bot√£o
            document.getElementById('edit-family-modal-title').textContent = 'Editar Fam√≠lia';
            
            modal.setAttribute('data-family-id', familyId);
            modal.classList.remove('hidden');
            console.log('‚úÖ [CONFIG] Modal de edi√ß√£o de fam√≠lia exibido');
        }

        // Salvar fam√≠lia
        async function saveFamily() {
            try {
                console.log('üíæ [CONFIG] Salvando fam√≠lia...');
                const modal = document.getElementById('edit-family-modal');
                const familyId = modal.getAttribute('data-family-id');
                
                const name = document.getElementById('edit-family-name').value.trim();
                const description = document.getElementById('edit-family-description').value.trim();
                
                if (!name) {
                    showToast('Erro', 'Nome da fam√≠lia √© obrigat√≥rio', 'error');
                    return;
                }
                
                const button = modal.querySelector('button[onclick="saveFamily()"]');
                const spinner = button.querySelector('.loading-spinner');
                const buttonText = button.querySelector('.button-text');
                
                try {
                    spinner.classList.remove('hidden');
                    button.disabled = true;
                    buttonText.textContent = 'Salvando...';
                    
                    const token = localStorage.getItem('token');
                    const response = await fetch(`/api/families/${familyId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ name, description })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        showToast('Sucesso', 'Fam√≠lia atualizada com sucesso!', 'success');
                        modal.classList.add('hidden');
                        modal.removeAttribute('data-family-id');
                        loadFamilies();
                        loadFamiliesForSelect();
                    } else {
                        showToast('Erro', result.message || 'Erro ao atualizar fam√≠lia', 'error');
                    }
                } catch (err) {
                    console.error('üí• [CONFIG] Erro na comunica√ß√£o:', err);
                    showToast('Erro', 'Falha na comunica√ß√£o com o servidor', 'error');
                } finally {
                    spinner.classList.add('hidden');
                    button.disabled = false;
                    buttonText.textContent = 'Salvar';
                }
            } catch (error) {
                console.error('üí• [CONFIG] Erro geral ao salvar fam√≠lia:', error);
                showToast('Erro', 'Erro inesperado ao salvar fam√≠lia', 'error');
            }
        }

        // Mostrar modal de exclus√£o de fam√≠lia
        function showDeleteFamilyModal(familyId, familyName) {
            console.log('üóëÔ∏è [CONFIG] Mostrando modal de exclus√£o para fam√≠lia:', { familyId, familyName });
            
            const modal = document.getElementById('delete-family-modal');
            if (modal) {
                document.getElementById('delete-family-name').textContent = familyName;
                modal.setAttribute('data-family-id', familyId);
                modal.classList.remove('hidden');
                console.log('‚úÖ [CONFIG] Modal de exclus√£o de fam√≠lia exibido');
            } else {
                console.error('‚ùå [CONFIG] Modal de exclus√£o de fam√≠lia n√£o encontrado!');
                showToast('Erro', 'Modal de exclus√£o de fam√≠lia n√£o dispon√≠vel', 'error');
            }
        }

        // Confirmar exclus√£o de fam√≠lia
        async function confirmDeleteFamily() {
            const modal = document.getElementById('delete-family-modal');
            const familyId = modal.getAttribute('data-family-id');
            if (familyId) {
                deleteFamily(familyId);
                closeModal('delete-family-modal');
            } else {
                console.error('‚ùå [CONFIG] ID da fam√≠lia n√£o encontrado no modal');
                showToast('Erro', 'Erro ao identificar fam√≠lia para exclus√£o', 'error');
            }
        }

        // Excluir fam√≠lia
        async function deleteFamily(familyId) {
            try {
                console.log('üóëÔ∏è [CONFIG] Excluindo fam√≠lia:', familyId);
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/families/${familyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                console.log('üì° [CONFIG] Resposta da exclus√£o:', response.status, result);
                
                if (response.ok && result.success) {
                    showToast('Sucesso', result.message || 'Fam√≠lia exclu√≠da com sucesso!', 'success');
                    loadFamilies();
                    loadFamiliesForSelect();
                } else {
                    showToast('Erro', result.message || 'Erro ao excluir fam√≠lia', 'error');
                }
            } catch (err) {
                console.error('üí• [CONFIG] Erro ao excluir fam√≠lia:', err);
                showToast('Erro', 'Falha na comunica√ß√£o com o servidor', 'error');
            }
        }

    </script>
</body>
</html> 