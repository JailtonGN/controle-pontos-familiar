<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√µes - Controle de Pontos Familiar</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/png" href="assets/logo.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- Modern Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-content">
                <!-- Brand -->
                <div class="navbar-brand">
                    <div class="navbar-logo"></div>
                    <div>
                        <div class="navbar-title">Configura√ß√µes</div>
                        <div class="navbar-subtitle">Sistema de Pontos</div>
                    </div>
                </div>

                <!-- Desktop Menu -->
                <div class="navbar-menu">
                    <div class="navbar-item">
                        <a href="/dashboard" class="navbar-button" id="nav-dashboard">
                            <span class="navbar-button-text">Tela Inicial</span>
                        </a>
                    </div>
                    <div class="navbar-item">
                        <a href="/manage-points" class="navbar-button" id="nav-activities">
                            <span class="navbar-button-text">Atividades</span>
                        </a>
                    </div>
                    <div class="navbar-item">
                        <a href="/kids" class="navbar-button" id="nav-kids">
                            <span class="navbar-button-text">Cadastros</span>
                        </a>
                    </div>
                    <div class="navbar-item">
                        <a href="/communication" class="navbar-button" id="nav-communication">
                            <span class="navbar-button-text">Comunica√ß√£o</span>
                        </a>
                    </div>
                    <div class="navbar-item">
                        <a href="/config" class="navbar-button active" id="nav-settings">
                            <span class="navbar-button-text">Configura√ß√£o</span>
                        </a>
                    </div>
                </div>

                <!-- User Menu -->
                <div class="navbar-user">
                    <span id="user-name" class="navbar-user-name"></span>
                    <button onclick="logout()" class="navbar-button navbar-button-logout">
                        Sair
                    </button>
                </div>

                <!-- Mobile Menu Button -->
                <div class="navbar-mobile-menu">
                    <button class="navbar-mobile-button" onclick="toggleMobileMenu()">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile Menu -->
            <div id="mobile-menu" class="navbar-mobile-menu-content hidden">
                <a href="/dashboard" class="navbar-mobile-item" onclick="setActiveNav('nav-dashboard')">
                    Tela Inicial
                </a>
                <a href="/manage-points" class="navbar-mobile-item" onclick="setActiveNav('nav-activities')">
                    Atividades
                </a>
                <a href="/kids" class="navbar-mobile-item" onclick="setActiveNav('nav-kids')">
                    Cadastros
                </a>
                <a href="/communication" class="navbar-mobile-item" onclick="setActiveNav('nav-communication')">
                    Comunica√ß√£o
                </a>
                <a href="/config" class="navbar-mobile-item active" onclick="setActiveNav('nav-settings')">
                    Configura√ß√£o
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container config-container" style="padding-top: 32px; padding-bottom: 32px;">
        
        <!-- Se√ß√£o de Perfil -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        üë§ Perfil do Usu√°rio
                    </div>
                </div>
                <div class="professional-card-content">
                    <div class="profile-info">
                        <div class="profile-avatar">üë§</div>
                        <div class="profile-details">
                            <h3 id="profile-name">Carregando...</h3>
                            <p id="profile-email">carregando@email.com</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Seguran√ßa -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        üîí Seguran√ßa
                    </div>
                </div>
                <div class="professional-card-content">
                    <h3>Alterar Senha</h3>
                    <form id="change-password-form" class="config-form">
                        <div class="form-group">
                            <label for="current-password">Senha Atual</label>
                            <input type="password" id="current-password" required>
                        </div>
                        <div class="form-group">
                            <label for="new-password">Nova Senha</label>
                            <input type="password" id="new-password" required>
                        </div>
                        <div class="form-group">
                            <label for="confirm-new-password">Confirmar Nova Senha</label>
                            <input type="password" id="confirm-new-password" required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span class="loading-spinner hidden"></span>
                            <span class="button-text">Alterar Senha</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Dados -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        üìä Gerenciamento de Dados
                    </div>
                </div>
                <div class="professional-card-content">
                    <!-- Aba de Registro (somente admin) -->
                    <div id="admin-register-card" class="config-card" style="display:none;">
                        <h3>üë§ Registro de Usu√°rios (Admin)</h3>
                        <p>Crie novos usu√°rios. Dispon√≠vel apenas para administradores.</p>
                        <form id="admin-register-form" class="config-form">
                            <div class="form-group">
                                <label for="admin-register-name">Nome</label>
                                <input type="text" id="admin-register-name" required>
                            </div>
                            <div class="form-group">
                                <label for="admin-register-email">Email</label>
                                <input type="email" id="admin-register-email" required>
                            </div>
                            <div class="form-group">
                                <label for="admin-register-password">Senha</label>
                                <input type="password" id="admin-register-password" required>
                            </div>
                            <div class="form-group">
                                <label for="admin-register-role">Perfil</label>
                                <select id="admin-register-role">
                                    <option value="parent">Pai/M√£e</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <span class="loading-spinner hidden"></span>
                                <span class="button-text">Criar Usu√°rio</span>
                            </button>
                        </form>
                    </div>
                    
                    <!-- Apagar Pontos -->
                    <div class="config-card danger">
                        <h3>üóëÔ∏è Apagar Todos os Pontos</h3>
                        <p class="warning-text">‚ö†Ô∏è Esta a√ß√£o ir√° remover TODOS os pontos de TODAS as crian√ßas. Esta a√ß√£o n√£o pode ser desfeita!</p>
                        <button onclick="confirmDeletePoints()" class="btn btn-danger">
                            Apagar Todos os Pontos
                        </button>
                    </div>

                    <!-- Apagar Hist√≥rico -->
                    <div class="config-card danger">
                        <h3>üóëÔ∏è Apagar Hist√≥rico Completo</h3>
                        <p class="warning-text">‚ö†Ô∏è Esta a√ß√£o ir√° remover TODO o hist√≥rico de pontos. Esta a√ß√£o n√£o pode ser desfeita!</p>
                        <button onclick="confirmDeleteHistory()" class="btn btn-danger">
                            Apagar Hist√≥rico Completo
                        </button>
                    </div>

                                         <!-- Baixar Hist√≥rico -->
                     <div class="config-card">
                         <h3>üìÑ Baixar Hist√≥rico em PDF</h3>
                         <p>Baixe o hist√≥rico de pontos organizado por crian√ßa e m√™s</p>
                         <div class="form-group">
                             <label for="history-month">Selecionar M√™s:</label>
                             <select id="history-month" class="form-control">
                                 <option value="">Carregando...</option>
                             </select>
                         </div>
                         <div class="form-group">
                             <label for="history-kid">Selecionar Crian√ßa (opcional):</label>
                             <select id="history-kid" class="form-control">
                                 <option value="">Todas as crian√ßas</option>
                             </select>
                         </div>
                         <button onclick="downloadHistoryPDF()" class="btn btn-secondary">
                             üìÑ Baixar Hist√≥rico
                         </button>
                     </div>

                                         <!-- Baixar Atividades -->
                     <div class="config-card">
                         <h3>üìã Baixar Relat√≥rio de Atividades</h3>
                         <p>Baixe um relat√≥rio completo de todas as atividades cadastradas</p>
                         <div class="form-group">
                             <label for="activities-filter">Filtrar por tipo:</label>
                             <select id="activities-filter" class="form-control">
                                 <option value="all">Todas as atividades</option>
                                 <option value="positive">Apenas positivas</option>
                                 <option value="negative">Apenas negativas</option>
                             </select>
                         </div>
                         <button onclick="downloadActivitiesPDF()" class="btn btn-secondary">
                             üìã Baixar Atividades
                         </button>
                     </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Estat√≠sticas -->
        <div class="professional-section">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        üìà Estat√≠sticas do Sistema
                    </div>
                </div>
                <div class="professional-card-content">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="total-kids">-</div>
                            <div class="stat-label">Crian√ßas Cadastradas</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="total-activities">-</div>
                            <div class="stat-label">Atividades Cadastradas</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="total-points">-</div>
                            <div class="stat-label">Total de Pontos</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="total-records">-</div>
                            <div class="stat-label">Registros de Pontos</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Gerenciamento de Usu√°rios (Admin) -->
        <div id="admin-users-section" class="professional-section" style="display:none;">
            <div class="professional-card">
                <div class="professional-card-header">
                    <div class="professional-card-title">
                        üë• Gerenciamento de Usu√°rios (Admin)
                    </div>
                </div>
                <div class="professional-card-content">
                    <div class="users-controls">
                        <button onclick="showAddUserModal()" class="btn btn-primary">
                            ‚ûï Novo Usu√°rio
                        </button>
                    </div>
                    
                    <div class="users-table-container">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Perfil</th>
                                    <th>Status</th>
                                    <th>√öltimo Login</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Usu√°rios ser√£o carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Modal Adicionar/Editar Usu√°rio -->
    <div id="user-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="user-modal-title">Adicionar Usu√°rio</h3>
                <button onclick="closeModal('user-modal')" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="user-form" class="config-form">
                    <div class="form-group">
                        <label for="user-name">Nome</label>
                        <input type="text" id="user-name" required>
                    </div>
                    <div class="form-group">
                        <label for="user-email">Email</label>
                        <input type="email" id="user-email" required>
                    </div>
                    <div class="form-group">
                        <label for="user-password">Senha</label>
                        <input type="password" id="user-password" required>
                    </div>
                    <div class="form-group">
                        <label for="user-role">Perfil</label>
                        <select id="user-role">
                            <option value="parent">Pai/M√£e</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="user-status">Status</label>
                        <select id="user-status">
                            <option value="true">Ativo</option>
                            <option value="false">Inativo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('user-modal')" class="btn btn-secondary">Cancelar</button>
                <button onclick="saveUser()" class="btn btn-primary">
                    <span class="loading-spinner hidden"></span>
                    <span class="button-text">Salvar</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Exclus√£o -->
    <div id="delete-user-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirmar Exclus√£o</h3>
                <button onclick="closeModal('delete-user-modal')" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o usu√°rio <strong id="delete-user-name"></strong>?</p>
                <p class="warning-text">‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita e remover√° todos os dados associados.</p>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('delete-user-modal')" class="btn btn-secondary">Cancelar</button>
                <button onclick="confirmDeleteUser()" class="btn btn-danger">Excluir</button>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script src="js/toast.js"></script>
    <script>
        // Client-side logic for config page
        // Carregar dados da p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            setActiveNav('nav-settings');
            setupAdminRegisterIfAllowed();
            loadUserProfile();
            loadStats();
        });

        // Carregar perfil do usu√°rio
        async function loadUserProfile() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/';
                    return;
                }

                const response = await fetch('/api/auth/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data && data.data.user) {
                        document.getElementById('user-name').textContent = data.data.user.name;
                        document.getElementById('profile-name').textContent = data.data.user.name;
                        document.getElementById('profile-email').textContent = data.data.user.email;
                        // Verificar se √© admin e mostrar se√ß√µes espec√≠ficas
                        if (data.data.user.role === 'admin') {
                            const adminCard = document.getElementById('admin-register-card');
                            if (adminCard) adminCard.style.display = 'block';
                            const adminUsersSection = document.getElementById('admin-users-section');
                            if (adminUsersSection) {
                                adminUsersSection.style.display = 'block';
                                loadUsers(); // Carregar usu√°rios apenas se for admin
                            }
                        }
                    } else {
                        throw new Error('Estrutura de dados inv√°lida');
                    }
                } else {
                    throw new Error('Erro ao carregar perfil');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro', 'Erro ao carregar perfil do usu√°rio', 'error');
            }
        }

        // Preparar formul√°rio de registro admin
        function setupAdminRegisterIfAllowed() {
            const form = document.getElementById('admin-register-form');
            if (!form) return;
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const name = document.getElementById('admin-register-name').value.trim();
                const email = document.getElementById('admin-register-email').value.trim();
                const password = document.getElementById('admin-register-password').value;
                const role = document.getElementById('admin-register-role').value;
                if (!name || !email || !password) {
                    showToast('Erro', 'Preencha todos os campos', 'error');
                    return;
                }
                if (password.length < 6) {
                    showToast('Erro', 'A senha deve ter pelo menos 6 caracteres', 'error');
                    return;
                }
                const button = form.querySelector('button[type="submit"]');
                const spinner = button.querySelector('.loading-spinner');
                const buttonText = button.querySelector('.button-text');
                try {
                    spinner.classList.remove('hidden');
                    button.disabled = true;
                    buttonText.textContent = 'Criando...';
                    const token = localStorage.getItem('token');
                    const resp = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ name, email, password, role })
                    });
                    const result = await resp.json();
                    if (resp.ok && result.success) {
                        showToast('Sucesso', 'Usu√°rio criado com sucesso', 'success');
                        form.reset();
                        loadUsers(); // Recarregar lista de usu√°rios
                    } else {
                        showToast('Erro', result.message || 'Erro ao criar usu√°rio', 'error');
                    }
                } catch (err) {
                    console.error(err);
                    showToast('Erro', 'Falha na comunica√ß√£o com o servidor', 'error');
                } finally {
                    spinner.classList.add('hidden');
                    button.disabled = false;
                    buttonText.textContent = 'Criar Usu√°rio';
                }
            });
        }

        // Carregar estat√≠sticas
        async function loadStats() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/kids', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const kidsData = await response.json();
                    const totalKids = kidsData.success && kidsData.data && kidsData.data.kids ? kidsData.data.kids.length : 0;
                    document.getElementById('total-kids').textContent = totalKids;

                    // Carregar atividades
                    const activitiesResponse = await fetch('/api/activities', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (activitiesResponse.ok) {
                        const activitiesData = await activitiesResponse.json();
                        const totalActivities = activitiesData.success && activitiesData.data && activitiesData.data.activities ? activitiesData.data.activities.length : 0;
                        document.getElementById('total-activities').textContent = totalActivities;
                    }

                    // Carregar pontos
                    const pointsResponse = await fetch('/api/points/history', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (pointsResponse.ok) {
                        const pointsData = await pointsResponse.json();
                        if (pointsData.success && pointsData.data && pointsData.data.history) {
                            const totalRecords = pointsData.data.history.length;
                            document.getElementById('total-records').textContent = totalRecords;

                            // Calcular total de pontos
                            let totalPointsValue = 0;
                            pointsData.data.history.forEach(point => {
                                if (point.type === 'add') {
                                    totalPointsValue += point.points;
                                } else {
                                    totalPointsValue -= point.points;
                                }
                            });
                            document.getElementById('total-points').textContent = totalPointsValue;
                        } else {
                            document.getElementById('total-records').textContent = '0';
                            document.getElementById('total-points').textContent = '0';
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
                // Definir valores padr√£o em caso de erro
                document.getElementById('total-kids').textContent = '0';
                document.getElementById('total-activities').textContent = '0';
                document.getElementById('total-records').textContent = '0';
                document.getElementById('total-points').textContent = '0';
            }
        }

        // Popular select de meses
        function populateMonthSelect() {
            const select = document.getElementById('history-month');
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            
            select.innerHTML = '<option value="">Selecione um m√™s</option>';
            
            // √öltimos 12 meses
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentYear, currentDate.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const monthName = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                const option = document.createElement('option');
                option.value = `${year}-${month}`;
                option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                select.appendChild(option);
            }
        }

        // Popular select de crian√ßas
        async function populateKidsSelect() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/kids', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('history-kid');
                    
                    if (data.success && data.data && data.data.kids && data.data.kids.length > 0) {
                        data.data.kids.forEach(kid => {
                            const option = document.createElement('option');
                            option.value = kid._id;
                            option.textContent = `${kid.name} (${kid.age} anos)`;
                            select.appendChild(option);
                        });
                    } else {
                        console.log('Nenhuma crian√ßa encontrada ou estrutura de dados inv√°lida:', data);
                    }
                } else {
                    console.error('Erro na resposta da API:', response.status);
                }
            } catch (error) {
                console.error('Erro ao carregar crian√ßas:', error);
            }
        }

        // Alterar senha
        document.getElementById('change-password-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            
            if (newPassword !== confirmPassword) {
                showToast('Erro', 'As senhas n√£o coincidem', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('Erro', 'A nova senha deve ter pelo menos 6 caracteres', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/auth/change-password', {
                    method: 'PUT', // Corrigido de POST para PUT
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('Sucesso', 'Senha alterada com sucesso!', 'success');
                    document.getElementById('change-password-form').reset();
                } else {
                    showToast('Erro', data.message || 'Erro ao alterar senha', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro', 'Erro ao alterar senha', 'error');
            }
        });

        // Confirmar exclus√£o de pontos
        function confirmDeletePoints() {
            showConfirmModal(
                'Apagar Todos os Pontos',
                'Tem certeza que deseja apagar TODOS os pontos de TODAS as crian√ßas? Esta a√ß√£o n√£o pode ser desfeita!',
                deleteAllPoints
            );
        }

        // Apagar todos os pontos
        async function deleteAllPoints() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/points/delete-all', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('Sucesso', data.message, 'success');
                    loadStats(); // Recarregar estat√≠sticas
                } else {
                    showToast('Erro', data.message || 'Erro ao apagar pontos', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro', 'Erro ao apagar pontos', 'error');
            }
        }

        // Confirmar exclus√£o de hist√≥rico
        function confirmDeleteHistory() {
            showConfirmModal(
                'Apagar Hist√≥rico Completo',
                'Tem certeza que deseja apagar TODO o hist√≥rico de pontos? Esta a√ß√£o n√£o pode ser desfeita!',
                deleteAllHistory
            );
        }

        // Apagar todo o hist√≥rico
        async function deleteAllHistory() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/points/delete-history', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('Sucesso', data.message, 'success');
                    loadStats(); // Recarregar estat√≠sticas
                } else {
                    showToast('Erro', data.message || 'Erro ao apagar hist√≥rico', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro', 'Erro ao apagar hist√≥rico', 'error');
            }
        }

        // Baixar hist√≥rico em PDF
        async function downloadHistoryPDF() {
            const month = document.getElementById('history-month').value;
            const kidId = document.getElementById('history-kid').value;
            
            if (!month) {
                showToast('Erro', 'Selecione um m√™s para baixar o hist√≥rico', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                let url = `/api/points/history-by-month?month=${month}`;
                if (kidId) {
                    url += `&kidId=${kidId}`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    generateHistoryPDF(data.data, kidId);
                } else {
                    showToast('Erro', data.message || 'Erro ao baixar hist√≥rico', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro', 'Erro ao baixar hist√≥rico', 'error');
            }
        }

                 // Baixar atividades em PDF
         async function downloadActivitiesPDF() {
             try {
                 const token = localStorage.getItem('token');
                 const response = await fetch('/api/activities', {
                     headers: {
                         'Authorization': `Bearer ${token}`
                     }
                 });
                 
                 const data = await response.json();
                 
                 if (response.ok && data.success && data.data && data.data.activities) {
                     const filterType = document.getElementById('activities-filter').value;
                     generateActivitiesPDF(data.data.activities, filterType);
                 } else {
                     showToast('Erro', data.message || 'Erro ao baixar atividades', 'error');
                 }
             } catch (error) {
                 console.error('Erro:', error);
                 showToast('Erro', 'Erro ao baixar atividades', 'error');
             }
         }

        // Gerar PDF do hist√≥rico
        function generateHistoryPDF(data, kidId) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // T√≠tulo
            doc.setFontSize(20);
            doc.text('Hist√≥rico de Pontos', 20, 20);
            
            doc.setFontSize(12);
            doc.text(`M√™s: ${data.month}`, 20, 30);
            doc.text(`Per√≠odo: ${new Date(data.startDate).toLocaleDateString('pt-BR')} a ${new Date(data.endDate).toLocaleDateString('pt-BR')}`, 20, 40);
            
            if (data.history.length === 0) {
                doc.text('Nenhum registro encontrado para este m√™s.', 20, 60);
            } else {
                // Agrupar por crian√ßa
                const kidsData = {};
                data.history.forEach(point => {
                    const kidName = point.kidId.name;
                    if (!kidsData[kidName]) {
                        kidsData[kidName] = [];
                    }
                    kidsData[kidName].push(point);
                });
                
                let yPosition = 60;
                
                Object.keys(kidsData).forEach(kidName => {
                    const points = kidsData[kidName];
                    
                    // Nome da crian√ßa
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Crian√ßa: ${kidName}`, 20, yPosition);
                    yPosition += 10;
                    
                    // Tabela de pontos
                    const tableData = points.map(point => [
                        new Date(point.date).toLocaleDateString('pt-BR'),
                        point.activityId ? point.activityId.name : 'Pontos avulsos',
                        point.type === 'add' ? `+${point.points}` : `-${point.points}`,
                        point.notes || '-'
                    ]);
                    
                    doc.autoTable({
                        startY: yPosition,
                        head: [['Data', 'Atividade', 'Pontos', 'Observa√ß√µes']],
                        body: tableData,
                        theme: 'grid',
                        headStyles: { fillColor: [66, 139, 202] }
                    });
                    
                    yPosition = doc.lastAutoTable.finalY + 15;
                    
                    // Calcular total da crian√ßa
                    const total = points.reduce((sum, point) => {
                        return sum + (point.type === 'add' ? point.points : -point.points);
                    }, 0);
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Total da crian√ßa: ${total} pontos`, 20, yPosition);
                    yPosition += 20;
                });
            }
            
            // Salvar PDF
            let fileName = `historico_pontos_${data.month}`;
            if (kidId) {
                const selectedKid = document.getElementById('history-kid').options[document.getElementById('history-kid').selectedIndex].text;
                fileName += `_${selectedKid.split(' ')[0]}`; // Adiciona o nome da crian√ßa ao arquivo
            }
            fileName += '.pdf';
            doc.save(fileName);
            showToast('Sucesso', 'PDF do hist√≥rico baixado com sucesso!', 'success');
        }

                 // Gerar PDF das atividades
         function generateActivitiesPDF(activities, filterType = 'all') {
             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();
             
             // T√≠tulo
             doc.setFontSize(20);
             doc.text('Relat√≥rio de Atividades', 20, 20);
             doc.setFontSize(12);
             doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 30);
             
             // Filtrar atividades baseado no tipo selecionado
             let filteredActivities = activities;
             let filterText = 'Todas as atividades';
             
             if (filterType === 'positive') {
                 filteredActivities = activities.filter(activity => activity.type === 'positive');
                 filterText = 'Apenas atividades positivas';
             } else if (filterType === 'negative') {
                 filteredActivities = activities.filter(activity => activity.type === 'negative');
                 filterText = 'Apenas atividades negativas';
             }
             
             doc.text(`Filtro: ${filterText}`, 20, 40);
             
             if (filteredActivities.length === 0) {
                 doc.text('Nenhuma atividade encontrada com o filtro selecionado.', 20, 60);
             } else {
                 // Ordenar alfabeticamente
                 filteredActivities.sort((a, b) => a.name.localeCompare(b.name));
                 
                 let yPosition = 60;
                 
                 // Se mostrar todas ou apenas positivas
                 if (filterType === 'all' || filterType === 'positive') {
                     const positiveActivities = filteredActivities.filter(activity => activity.type === 'positive');
                     if (positiveActivities.length > 0) {
                         doc.setFontSize(14);
                         doc.setFont(undefined, 'bold');
                         doc.text('‚úÖ Atividades Positivas', 20, yPosition);
                         yPosition += 10;
                         
                         const positiveData = positiveActivities.map(activity => [
                             activity.name,
                             activity.points,
                             activity.icon,
                             activity.description || '-'
                         ]);
                         
                         doc.autoTable({
                             startY: yPosition,
                             head: [['Atividade', 'Pontos', '√çcone', 'Descri√ß√£o']],
                             body: positiveData,
                             theme: 'grid',
                             headStyles: { fillColor: [40, 167, 69] }
                         });
                         
                         yPosition = doc.lastAutoTable.finalY + 20;
                     }
                 }
                 
                 // Se mostrar todas ou apenas negativas
                 if (filterType === 'all' || filterType === 'negative') {
                     const negativeActivities = filteredActivities.filter(activity => activity.type === 'negative');
                     if (negativeActivities.length > 0) {
                         doc.setFontSize(14);
                         doc.setFont(undefined, 'bold');
                         doc.text('‚ùå Atividades Negativas', 20, yPosition);
                         yPosition += 10;
                         
                         const negativeData = negativeActivities.map(activity => [
                             activity.name,
                             activity.points,
                             activity.icon,
                             activity.description || '-'
                         ]);
                         
                         doc.autoTable({
                             startY: yPosition,
                             head: [['Atividade', 'Pontos', '√çcone', 'Descri√ß√£o']],
                             body: negativeData,
                             theme: 'grid',
                             headStyles: { fillColor: [220, 53, 69] }
                         });
                     }
                 }
             }
             
             // Salvar PDF
             let fileName = `relatorio_atividades_${new Date().toISOString().split('T')[0]}`;
             if (filterType !== 'all') {
                 fileName += `_${filterType}`;
             }
             fileName += '.pdf';
             doc.save(fileName);
             showToast('Sucesso', 'PDF das atividades baixado com sucesso!', 'success');
         }

        // Fun√ß√µes auxiliares para modais
        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-confirm-btn').onclick = () => {
                closeModal('confirm-modal');
                onConfirm();
            };
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function showToast(title, message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                // Create a container if it doesn't exist
                const newToastContainer = document.createElement('div');
                newToastContainer.id = 'toast-container';
                newToastContainer.style.position = 'fixed';
                newToastContainer.style.top = '20px';
                newToastContainer.style.right = '20px';
                newToastContainer.style.zIndex = '10000';
                document.body.appendChild(newToastContainer);
            }

            const toast = document.createElement('div');
            toast.classList.add('toast', `toast-${type}`);
            toast.innerHTML = `
                <div class="toast-header">
                    <strong>${title}</strong>
                    <button class="toast-close-button" onclick="closeToast(this.parentElement)">&times;</button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            document.getElementById('toast-container').appendChild(toast);

            // Automatically remove the toast after 5 seconds
            setTimeout(() => {
                closeToast(toast);
            }, 5000);
        }

        function closeToast(toast) {
            toast.classList.remove('show');
            toast.classList.add('hide');
            setTimeout(() => {
                toast.remove();
            }, 300); // Remove after transition
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Fun√ß√µes para gerenciamento de usu√°rios (Admin)
        async function loadUsers() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('Token n√£o encontrado');
                    return;
                }

                const response = await fetch('/api/auth/users', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.success && data.data && data.data.users) {
                    const tbody = document.getElementById('users-table-body');
                    if (!tbody) {
                        console.error('Elemento users-table-body n√£o encontrado');
                        return;
                    }
                    tbody.innerHTML = ''; // Limpar tabela antes de adicionar
                    data.data.users.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.name || ''}</td>
                            <td>${user.email || ''}</td>
                            <td>${user.role === 'admin' ? 'Administrador' : 'Pai/M√£e'}</td>
                            <td><span class="status-badge ${user.isActive ? 'active' : 'inactive'}">${user.isActive ? 'Ativo' : 'Inativo'}</span></td>
                            <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('pt-BR') : '-'}</td>
                            <td>
                                <button onclick="showEditUserModal('${user._id}', '${user.name || ''}', '${user.email || ''}', '${user.role || 'parent'}', ${user.isActive || false})" class="btn btn-sm btn-info">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="showDeleteUserModal('${user._id}', '${user.name || ''}')" class="btn btn-sm btn-danger">
                                    üóëÔ∏è Excluir
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    console.error('Erro ao carregar usu√°rios:', data.message);
                    showToast('Erro', data.message || 'Erro ao carregar usu√°rios', 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                showToast('Erro', 'Erro ao carregar usu√°rios', 'error');
            }
        }

        function showAddUserModal() {
            document.getElementById('user-modal-title').textContent = 'Adicionar Usu√°rio';
            document.getElementById('user-form').reset();
            document.getElementById('user-password').required = true;
            document.getElementById('user-password').placeholder = 'Digite a senha';
            document.getElementById('user-modal').removeAttribute('data-user-id');
            document.getElementById('user-modal').classList.remove('hidden');
        }

        function showEditUserModal(userId, name, email, role, isActive) {
            document.getElementById('user-modal-title').textContent = 'Editar Usu√°rio';
            document.getElementById('user-form').reset();
            document.getElementById('user-name').value = name || '';
            document.getElementById('user-email').value = email || '';
            document.getElementById('user-role').value = role || 'parent';
            document.getElementById('user-status').value = isActive ? 'true' : 'false';
            document.getElementById('user-password').required = false;
            document.getElementById('user-password').placeholder = 'Deixe em branco para manter a senha atual';
            document.getElementById('user-modal').setAttribute('data-user-id', userId);
            document.getElementById('user-modal').classList.remove('hidden');
        }

        async function saveUser() {
            const modal = document.getElementById('user-modal');
            const userId = modal.getAttribute('data-user-id');
            const isEdit = !!userId;
            
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const password = document.getElementById('user-password').value;
            const role = document.getElementById('user-role').value;
            const isActive = document.getElementById('user-status').value === 'true';

            if (!name || !email) {
                showToast('Erro', 'Nome e Email s√£o obrigat√≥rios', 'error');
                return;
            }

            if (!isEdit && (!password || password.length < 6)) {
                showToast('Erro', 'A senha deve ter pelo menos 6 caracteres', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const button = modal.querySelector('button[onclick="saveUser()"]');
                const spinner = button.querySelector('.loading-spinner');
                const buttonText = button.querySelector('.button-text');
                
                spinner.classList.remove('hidden');
                button.disabled = true;
                buttonText.textContent = 'Salvando...';

                const url = isEdit ? `/api/auth/users/${userId}` : '/api/auth/register';
                const method = isEdit ? 'PUT' : 'POST';
                
                const body = { name, email, role, isActive };
                if (password && password.length > 0) body.password = password;

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(body)
                });
                
                const result = await response.json();

                if (response.ok && result.success) {
                    showToast('Sucesso', result.message || 'Usu√°rio salvo com sucesso!', 'success');
                    modal.classList.add('hidden');
                    modal.removeAttribute('data-user-id');
                    loadUsers();
                } else {
                    showToast('Erro', result.message || 'Erro ao salvar usu√°rio', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Erro', 'Falha na comunica√ß√£o com o servidor', 'error');
            } finally {
                const button = modal.querySelector('button[onclick="saveUser()"]');
                const spinner = button.querySelector('.loading-spinner');
                const buttonText = button.querySelector('.button-text');
                spinner.classList.add('hidden');
                button.disabled = false;
                buttonText.textContent = 'Salvar';
            }
        }

        function showDeleteUserModal(userId, userName) {
            document.getElementById('delete-user-name').textContent = userName || 'este usu√°rio';
            document.getElementById('delete-user-modal').setAttribute('data-user-id', userId);
            document.getElementById('delete-user-modal').classList.remove('hidden');
        }

        async function confirmDeleteUser() {
            const modal = document.getElementById('delete-user-modal');
            const userId = modal.getAttribute('data-user-id');
            
            if (!userId) {
                showToast('Erro', 'ID do usu√°rio n√£o encontrado', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/auth/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showToast('Sucesso', result.message || 'Usu√°rio exclu√≠do com sucesso!', 'success');
                    modal.classList.add('hidden');
                    modal.removeAttribute('data-user-id');
                    loadUsers();
                } else {
                    showToast('Erro', result.message || 'Erro ao excluir usu√°rio', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Erro', 'Falha na comunica√ß√£o com o servidor', 'error');
            }
        }
    </script>
</body>
</html> 