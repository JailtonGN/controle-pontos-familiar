<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualização da Criança - Controle de Pontos Familiar</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/child-view.css">
    <link rel="icon" type="image/png" href="assets/logo.png">
</head>
<body>
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <button onclick="goBack()" class="btn btn-secondary mr-4">
                        <span class="text-2xl">←</span>
                    </button>
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                            C
                        </div>
                    </div>
                    <div class="ml-3">
                        <h1 id="kid-name" class="text-xl font-semibold text-gray-900">Criança</h1>
                        <p class="text-sm text-gray-500">Detalhes e Progresso</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="goToDashboard()" class="btn btn-primary">
                        Dashboard
                    </button>
                    <button onclick="logout()" class="btn btn-secondary">
                        Sair
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container" style="padding-top: 32px; padding-bottom: 32px;">
        <!-- Informações da Criança -->
        <div class="mb-8">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div id="kid-avatar" class="kid-avatar mr-6">
                            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-xl">
                                C
                            </div>
                        </div>
                        <div>
                            <h2 id="kid-name-header" class="text-2xl font-bold text-gray-900">Nome da Criança</h2>
                            <p id="kid-age" class="text-gray-600">Idade anos</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="points-badge text-lg px-4 py-2">
                            <span id="kid-total-points">0</span> pontos
                        </div>
                        <div class="level-badge mt-2">
                            Nível <span id="kid-level">1</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estatísticas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="flex items-center">
                        <div class="stat-card-icon">
                            <div class="w-8 h-8 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full flex items-center justify-center text-white font-bold">
                                P
                            </div>
                        </div>
                        <div class="stat-card-content">
                            <div class="stat-card-title">Pontos Hoje</div>
                            <div id="points-today" class="stat-card-value">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="flex items-center">
                        <div class="stat-card-icon">
                            <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-white font-bold">
                                A
                            </div>
                        </div>
                        <div class="stat-card-content">
                            <div class="stat-card-title">Atividades Realizadas</div>
                            <div id="activities-count" class="stat-card-value">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="flex items-center">
                        <div class="stat-card-icon">
                            <div class="w-8 h-8 bg-gradient-to-r from-green-400 to-green-600 rounded-full flex items-center justify-center text-white font-bold">
                                O
                            </div>
                        </div>
                        <div class="stat-card-content">
                            <div class="stat-card-title">Objetivos Ativos</div>
                            <div id="active-goals" class="stat-card-value">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="flex items-center">
                        <div class="stat-card-icon">
                            <div class="w-8 h-8 bg-gradient-to-r from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                                %
                            </div>
                        </div>
                        <div class="stat-card-content">
                            <div class="stat-card-title">Progresso do Nível</div>
                            <div id="level-progress" class="stat-card-value">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ações -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-medium text-gray-900">Ações</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="showAddPointsModal()" class="btn btn-success w-full">
                    Adicionar Pontos
                </button>
                <button onclick="showRemovePointsModal()" class="btn btn-danger w-full">
                    Remover Pontos
                </button>
                <button onclick="showGoalsModal()" class="btn btn-primary w-full">
                    Gerenciar Objetivos
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6">
            <div class="flex rounded-lg bg-gray-100 p-1">
                <button id="history-tab" class="tab-button active flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all duration-200">
                    Histórico de Pontos
                </button>
                <button id="stats-tab" class="tab-button flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all duration-200">
                    Estatísticas
                </button>
                <button id="goals-tab" class="tab-button flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all duration-200">
                    Objetivos
                </button>
            </div>
        </div>

        <!-- Conteúdo das Tabs -->
        <div id="history-content" class="tab-content">
            <div class="bg-white rounded-lg shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Histórico de Pontos</h3>
                </div>
                <div class="p-6">
                    <div id="points-history" class="space-y-4">
                        <!-- Histórico será carregado aqui -->
                    </div>
                </div>
            </div>
        </div>

        <div id="stats-content" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Estatísticas por Categoria</h3>
                </div>
                <div class="p-6">
                    <div id="stats-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Estatísticas serão carregadas aqui -->
                    </div>
                </div>
            </div>
        </div>

        <div id="goals-content" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Objetivos</h3>
                </div>
                <div class="p-6">
                    <div id="goals-container" class="space-y-4">
                        <!-- Objetivos serão carregados aqui -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Adicionar Pontos -->
    <div id="add-points-modal" class="modal hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Adicionar Pontos</h3>
                    <button onclick="hideAddPointsModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="text-2xl">×</span>
                    </button>
                </div>
                <form id="add-points-form" class="space-y-4">
                    <div>
                        <label for="points-activity" class="block text-sm font-medium text-gray-700">Atividade</label>
                        <select id="points-activity" name="activityId" required class="input">
                            <option value="">Selecione uma atividade</option>
                        </select>
                    </div>
                    <div>
                        <label for="points-amount" class="block text-sm font-medium text-gray-700">Pontos</label>
                        <input type="number" id="points-amount" name="points" min="1" max="500" required class="input">
                    </div>
                    <div>
                        <label for="points-notes" class="block text-sm font-medium text-gray-700">Observações</label>
                        <textarea id="points-notes" name="notes" rows="3" class="input"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideAddPointsModal()" class="btn btn-secondary">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            Adicionar Pontos
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Remover Pontos -->
    <div id="remove-points-modal" class="modal hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Remover Pontos</h3>
                    <button onclick="hideRemovePointsModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="text-2xl">×</span>
                    </button>
                </div>
                <form id="remove-points-form" class="space-y-4">
                    <div>
                        <label for="remove-points-amount" class="block text-sm font-medium text-gray-700">Pontos a Remover</label>
                        <input type="number" id="remove-points-amount" name="points" min="1" max="500" required class="input">
                    </div>
                    <div>
                        <label for="remove-points-notes" class="block text-sm font-medium text-gray-700">Motivo</label>
                        <textarea id="remove-points-notes" name="notes" rows="3" class="input"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideRemovePointsModal()" class="btn btn-secondary">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-danger">
                            Remover Pontos
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Notificação -->
    <div id="notification-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
                <div class="flex items-center mb-4">
                    <div id="notification-icon" class="flex-shrink-0 mr-3"></div>
                    <h3 id="notification-title" class="text-lg font-medium text-gray-900"></h3>
                </div>
                <p id="notification-message" class="text-sm text-gray-500 mb-4"></p>
                <div class="flex justify-end">
                    <button id="notification-close" 
                            class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script src="js/toast.js"></script>
    <script>
        // Variáveis globais
        let currentKid = null;
        let activities = [];

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const kidId = urlParams.get('id');
            
            if (kidId) {
                loadKidDetails(kidId);
            } else {
                showNotification('Erro', 'ID da criança não fornecido', 'error');
                setTimeout(() => goToDashboard(), 2000);
            }
        });

        // Carregar detalhes da criança
        async function loadKidDetails(kidId) {
            try {
                const [kidResponse, activitiesResponse] = await Promise.all([
                    API.get(`/kids/${kidId}`),
                    API.get('/activities')
                ]);

                currentKid = kidResponse.data.kid;
                activities = activitiesResponse.data.activities;

                updateKidInfo();
                loadStats();
                loadPointsHistory();
                updateActivitiesSelect();
            } catch (error) {
                showNotification('Erro', 'Erro ao carregar dados da criança', 'error');
            }
        }

        // Atualizar informações da criança
        function updateKidInfo() {
            if (!currentKid) return;

            document.getElementById('kid-name').textContent = currentKid.name;
            document.getElementById('kid-name-header').textContent = currentKid.name;
            document.getElementById('kid-age').textContent = `${currentKid.age} anos`;
            document.getElementById('kid-avatar').textContent = currentKid.avatar || '👶';
            document.getElementById('kid-total-points').textContent = formatPoints(currentKid.totalPoints);
            document.getElementById('kid-level').textContent = currentKid.currentLevel;
        }

        // Carregar estatísticas
        async function loadStats() {
            if (!currentKid) return;

            try {
                const [statsResponse, goalsResponse] = await Promise.all([
                    API.get(`/points/stats/${currentKid._id}`),
                    API.get(`/kids/${currentKid._id}/goals`)
                ]);

                const stats = statsResponse.data.stats;
                const goals = goalsResponse.data.goals;
                const activeGoals = goals.filter(goal => !goal.isCompleted);

                document.getElementById('points-today').textContent = stats.totalPoints ?? 0;
                document.getElementById('activities-count').textContent = stats.totalActivities || 0;
                document.getElementById('active-goals').textContent = activeGoals.length;
                
                const levelProgress = currentKid.getLevelProgress ? currentKid.getLevelProgress().progressPercentage : 0;
                document.getElementById('level-progress').textContent = `${levelProgress}%`;
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // Carregar histórico de pontos
        async function loadPointsHistory() {
            if (!currentKid) return;

            try {
                const response = await API.get(`/points/history/${currentKid._id}`);
                const points = response.data.points;

                const container = document.getElementById('points-history');
                
                if (points.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-gray-400 text-4xl mb-4">📊</div>
                            <p class="text-gray-500">Nenhum ponto registrado ainda</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = points.map(point => `
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-4">
                                <span class="text-lg">${point.activityId?.icon || '⭐'}</span>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-900">${point.activityId?.name || (point.reason || 'Ponto Avulso')}</h4>
                                <p class="text-sm text-gray-500">${formatDate(point.date)}</p>
                                ${point.notes ? `<p class="text-sm text-gray-600 mt-1">${point.notes}</p>` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-semibold ${point.type === 'add' ? 'text-green-600' : 'text-red-600'}">
                                ${point.type === 'add' ? '+' : '-'}${point.points}
                            </div>
                            <div class="text-sm text-gray-500">por ${point.awardedBy?.name || 'Usuário'}</div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
            }
        }

        // Atualizar select de atividades
        function updateActivitiesSelect() {
            const select = document.getElementById('points-activity');
            select.innerHTML = '<option value="">Selecione uma atividade</option>';
            activities.forEach(activity => {
                select.innerHTML += `<option value="${activity._id}" data-points="${activity.points}">${activity.icon} ${activity.name} (${activity.points} pts)</option>`;
            });
        }

        // Navegação
        function goBack() {
            window.history.back();
        }

        function goToDashboard() {
            window.location.href = '/dashboard';
        }

        // Modais
        function showAddPointsModal() {
            document.getElementById('add-points-modal').classList.remove('hidden');
        }

        function hideAddPointsModal() {
            document.getElementById('add-points-modal').classList.add('hidden');
            document.getElementById('add-points-form').reset();
        }

        function showRemovePointsModal() {
            document.getElementById('remove-points-modal').classList.remove('hidden');
        }

        function hideRemovePointsModal() {
            document.getElementById('remove-points-modal').classList.add('hidden');
            document.getElementById('remove-points-form').reset();
        }

        function showGoalsModal() {
            showToast('Info', 'Funcionalidade em desenvolvimento', 'info');
        }

        // Tabs
        document.getElementById('history-tab').addEventListener('click', function() {
            showTab('history');
        });

        document.getElementById('stats-tab').addEventListener('click', function() {
            showTab('stats');
        });

        document.getElementById('goals-tab').addEventListener('click', function() {
            showTab('goals');
        });

        function showTab(tabName) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-button').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            // Mostrar tab selecionada
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
        }

        // Event listeners
        document.getElementById('add-points-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                kidId: currentKid._id,
                activityId: formData.get('activityId'),
                points: parseInt(formData.get('points')),
                notes: formData.get('notes') || ''
            };

            try {
                await API.post('/points/add', data);
                showToast('Sucesso', 'Pontos adicionados com sucesso!', 'success');
                hideAddPointsModal();
                loadKidDetails(currentKid._id);
            } catch (error) {
                showToast('Erro', error.message, 'error');
            }
        });

        document.getElementById('remove-points-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                kidId: currentKid._id,
                points: parseInt(formData.get('points')),
                notes: formData.get('notes') || ''
            };

            try {
                await API.post('/points/remove', data);
                showToast('Sucesso', 'Pontos removidos com sucesso!', 'success');
                hideRemovePointsModal();
                loadKidDetails(currentKid._id);
            } catch (error) {
                showToast('Erro', error.message, 'error');
            }
        });

        // Auto-preencher pontos quando atividade for selecionada
        document.getElementById('points-activity').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const points = selectedOption.dataset.points;
            if (points) {
                document.getElementById('points-amount').value = points;
            }
        });
    </script>
</body>
</html> 